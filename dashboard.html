<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Virtual Pedagogue</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            font-weight: 700;
        }

        .user-details h1 {
            font-size: 24px;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .user-details p {
            color: #6b7280;
            font-size: 14px;
        }

        .logout-btn {
            padding: 12px 24px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .tabs-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #f3f4f6;
            background: #f9fafb;
            overflow-x: auto;
        }

        .tab {
            padding: 20px 30px;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab:hover {
            color: #4f46e5;
            background: rgba(79, 70, 229, 0.05);
        }

        .tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 16px;
            color: white;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }

        .achievement {
            text-align: center;
            padding: 20px;
            border-radius: 16px;
            background: #f9fafb;
            transition: all 0.3s;
        }

        .achievement.locked {
            opacity: 0.4;
        }

        .achievement:not(.locked):hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.2);
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .achievement-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 12px;
            color: #6b7280;
        }

        .session-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-info h3 {
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .session-info p {
            font-size: 14px;
            color: #6b7280;
        }

        .session-score {
            font-size: 32px;
            font-weight: 800;
            color: #4f46e5;
        }

        .btn-primary {
            display: inline-block;
            padding: 14px 28px;
            background: linear-gradient(135deg, #4f46e5, #8b5cf6);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #6b7280;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="user-info">
                <div class="avatar" id="userAvatar">?</div>
                <div class="user-details">
                    <h1 id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                    <p id="userEmail"></p>
                </div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">–í—ã–π—Ç–∏</button>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="tab" onclick="switchTab('skills')">üí™ –ù–∞–≤—ã–∫–∏</div>
                <div class="tab" onclick="switchTab('achievements')">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                <div class="tab" onclick="switchTab('history')">üìù –ò—Å—Ç–æ—Ä–∏—è</div>
                <div class="tab" onclick="switchTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>

            <!-- Tab: Statistics -->
            <div id="stats-tab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalSessions">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="averageScore">0</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="streak">0üî•</div>
                        <div class="stat-label">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalTime">0—á</div>
                        <div class="stat-label">–í—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                    </div>
                </div>

                <!-- Detailed Summary Analytics -->
                <div style="margin-top: 30px;">
                    <h2 style="margin-bottom: 20px;">üìä –°–≤–æ–¥–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                    <div id="summaryAnalytics" style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 18px; margin-bottom: 15px; color: #4f46e5;">–°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞–≤—ã–∫–æ–≤</h3>
                            <div id="avgSkillsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <!-- Will be filled by JavaScript -->
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                            <h3 style="font-size: 18px; margin-bottom: 10px; color: #4f46e5;">–ü—Ä–æ–≥—Ä–µ—Å—Å</h3>
                            <div id="progressSummary" style="color: #666; line-height: 1.8;">
                                <!-- Will be filled by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <a href="scenarios.html" class="btn-primary" style="margin-top: 20px;">üéØ –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</a>
            </div>

            <!-- Tab: Skills -->
            <div id="skills-tab" class="tab-content">
                <h2 style="margin-bottom: 20px;">–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞–≤—ã–∫–æ–≤</h2>
                <div class="chart-container">
                    <canvas id="skillsRadar"></canvas>
                </div>
            </div>

            <!-- Tab: Achievements -->
            <div id="achievements-tab" class="tab-content">
                <h2 style="margin-bottom: 20px;">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>

            <!-- Tab: History -->
            <div id="history-tab" class="tab-content">
                <h2 style="margin-bottom: 20px;">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2>
                <div id="sessionsHistory"></div>
            </div>

            <!-- Tab: Settings -->
            <div id="settings-tab" class="tab-content">
                <h2 style="margin-bottom: 20px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
                <div style="max-width: 500px;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">–ò–º—è</label>
                        <input type="text" id="displayName"
                            style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email</label>
                        <input type="email" id="emailInput" disabled
                            style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; background: #f9fafb;">
                    </div>
                    <button class="btn-primary" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB7SBp_tDfeumEjJ6l8QpnamHeXA5OiWyg",
            authDomain: "test-89bad.firebaseapp.com",
            projectId: "test-89bad",
            storageBucket: "test-89bad.firebasestorage.app",
            messagingSenderId: "798844876458",
            appId: "1:798844876458:web:fa13cdaf2eec1a43ffc2d3"
        };
    </script>

    <script src="user-manager.js"></script>
    <script>
        let skillsChart = null;
        let sessionsCache = []; // Cache for session data

        // Initialize
        userManager.init(firebaseConfig);

        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'auth.html';
                return;
            }

            await userManager.loadUserData(user.uid);
            renderDashboard();
        });

        function renderDashboard() {
            const profile = userManager.getProfile();
            if (!profile) return;

            // User info
            const initials = profile.displayName ? profile.displayName.charAt(0).toUpperCase() : '?';
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('userName').textContent = profile.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('userEmail').textContent = profile.email;

            // Stats
            document.getElementById('totalSessions').textContent = profile.progress.totalSessions;
            document.getElementById('averageScore').textContent = profile.progress.averageScore;
            document.getElementById('streak').textContent = profile.progress.streak + 'üî•';

            const hours = Math.floor(profile.progress.totalTimeSpent / 3600);
            const minutes = Math.floor((profile.progress.totalTimeSpent % 3600) / 60);
            document.getElementById('totalTime').textContent = hours > 0
                ? hours + '—á ' + minutes + '–º'
                : minutes + '–º';

            // Skills Chart
            renderSkillsChart(profile.skills);

            // Achievements
            renderAchievements(profile.achievements);

            // History
            renderHistory();

            // Summary Analytics
            renderSummaryAnalytics();

            // Settings
            document.getElementById('displayName').value = profile.displayName || '';
            document.getElementById('emailInput').value = profile.email;
        }

        async function renderSummaryAnalytics() {
            const sessions = await userManager.getSessionHistory(100); // Get all sessions
            const profile = userManager.getProfile();

            if (!sessions || sessions.length === 0) {
                document.getElementById('summaryAnalytics').innerHTML = `
                    <p style="text-align: center; color: #999; padding: 20px;">
                        –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ü—Ä–æ–π–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–∫–æ–≤!
                    </p>
                `;
                return;
            }

            // Calculate average skills
            const skillsSum = {
                empathy: 0,
                conflictResolution: 0,
                boundaryKeeping: 0,
                patience: 0
            };
            let skillsCount = 0;

            sessions.forEach(session => {
                if (session.aiAnalysis && session.aiAnalysis.skills) {
                    skillsSum.empathy += session.aiAnalysis.skills.empathy || 0;
                    skillsSum.conflictResolution += session.aiAnalysis.skills.conflictResolution || 0;
                    skillsSum.boundaryKeeping += session.aiAnalysis.skills.boundaryKeeping || 0;
                    skillsSum.patience += session.aiAnalysis.skills.patience || 0;
                    skillsCount++;
                }
            });

            const avgSkills = {
                empathy: skillsCount > 0 ? Math.round(skillsSum.empathy / skillsCount) : 0,
                conflictResolution: skillsCount > 0 ? Math.round(skillsSum.conflictResolution / skillsCount) : 0,
                boundaryKeeping: skillsCount > 0 ? Math.round(skillsSum.boundaryKeeping / skillsCount) : 0,
                patience: skillsCount > 0 ? Math.round(skillsSum.patience / skillsCount) : 0
            };

            const skillNames = {
                empathy: '–≠–º–ø–∞—Ç–∏—è',
                conflictResolution: '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤',
                boundaryKeeping: '–ì—Ä–∞–Ω–∏—Ü—ã',
                patience: '–¢–µ—Ä–ø–µ–Ω–∏–µ'
            };

            const skillTips = {
                empathy: '–°—Ç–∞—Ä–∞–π—Ç–µ—Å—å –ø–æ–Ω–∏–º–∞—Ç—å —ç–º–æ—Ü–∏–∏ —É—á–µ–Ω–∏–∫–æ–≤ –∏ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å —Å —Å–æ—á—É–≤—Å—Ç–≤–∏–µ–º',
                conflictResolution: '–£—á–∏—Ç–µ—Å—å –Ω–∞—Ö–æ–¥–∏—Ç—å –∫–æ–º–ø—Ä–æ–º–∏—Å—Å—ã –∏ –º–∏—Ä–Ω–æ —Ä–∞–∑—Ä–µ—à–∞—Ç—å —Å–ø–æ—Ä—ã',
                boundaryKeeping: '–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ —á–µ—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∏—Ö',
                patience: '–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –¥–∞–∂–µ –≤ —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö'
            };

            // Render average skills
            document.getElementById('avgSkillsGrid').innerHTML = Object.entries(avgSkills).map(([skill, value]) => {
                const color = value >= 75 ? '#10b981' : value >= 50 ? '#f59e0b' : '#ef4444';
                return `
                    <div style="background: #f9fafb; padding: 15px; border-radius: 10px; border-left: 4px solid ${color};">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">${skillNames[skill]}</div>
                        <div style="font-size: 28px; font-weight: 700; color: ${color}; margin-bottom: 8px;">${value}/100</div>
                        <div style="font-size: 12px; color: #666; line-height: 1.4;">üí° ${skillTips[skill]}</div>
                    </div>
                `;
            }).join('');

            // Calculate trends
            const recentSessions = sessions.slice(0, 5);
            const recentAvgScore = recentSessions.reduce((sum, s) => sum + (s.score || 0), 0) / recentSessions.length;
            const allAvgScore = sessions.reduce((sum, s) => sum + (s.score || 0), 0) / sessions.length;
            const trend = recentAvgScore > allAvgScore ? 'üìà –†–∞—Å—Ç–µ—Ç' : recentAvgScore < allAvgScore ? 'üìâ –°–Ω–∏–∂–∞–µ—Ç—Å—è' : '‚û°Ô∏è –°—Ç–∞–±–∏–ª—å–Ω–æ';
            const trendColor = recentAvgScore > allAvgScore ? '#10b981' : recentAvgScore < allAvgScore ? '#ef4444' : '#6b7280';

            document.getElementById('progressSummary').innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>–î–∏–Ω–∞–º–∏–∫–∞:</strong> <span style="color: ${trendColor}; font-weight: 600;">${trend}</span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —É—Ä–æ–∫–æ–≤:</strong> ${Math.round(recentAvgScore)} –±–∞–ª–ª–æ–≤ (—Å—Ä–µ–¥–Ω–∏–π)
                </div>
                <div>
                    <strong>–í—Å–µ–≥–æ –ø—Ä–æ–π–¥–µ–Ω–æ:</strong> ${sessions.length} ${sessions.length === 1 ? '—É—Ä–æ–∫' : sessions.length < 5 ? '—É—Ä–æ–∫–∞' : '—É—Ä–æ–∫–æ–≤'}
                </div>
            `;
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function renderSkillsChart(skills) {
            const ctx = document.getElementById('skillsRadar').getContext('2d');

            if (skillsChart) {
                skillsChart.destroy();
            }

            skillsChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['–≠–º–ø–∞—Ç–∏—è', '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤', '–ì—Ä–∞–Ω–∏—Ü—ã', '–¢–µ—Ä–ø–µ–Ω–∏–µ'],
                    datasets: [{
                        label: '–í–∞—à–∏ –Ω–∞–≤—ã–∫–∏',
                        data: [
                            skills.empathy,
                            skills.conflictResolution,
                            skills.boundaryKeeping,
                            skills.patience
                        ],
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(79, 70, 229, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 25
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function renderAchievements(userAchievements) {
            const grid = document.getElementById('achievementsGrid');

            const allAchievements = [
                { id: "first_session", title: "–ü–µ—Ä–≤—ã–π —à–∞–≥", description: "–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É", icon: "üéì" },
                { id: "empathy_master", title: "–ú–∞—Å—Ç–µ—Ä —ç–º–ø–∞—Ç–∏–∏", description: "80+ –±–∞–ª–ª–æ–≤ –≤ —ç–º–ø–∞—Ç–∏–∏", icon: "‚ù§Ô∏è" },
                { id: "patient_teacher", title: "–¢–µ—Ä–ø–µ–ª–∏–≤—ã–π –ø–µ–¥–∞–≥–æ–≥", description: "90+ –±–∞–ª–ª–æ–≤ –≤ —Ç–µ—Ä–ø–µ–Ω–∏–∏", icon: "üßò" },
                { id: "conflict_resolver", title: "–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—â–∏–∫", description: "10 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ", icon: "ü§ù" },
                { id: "week_streak", title: "–ù–µ–¥–µ–ª—è –ø–æ–¥—Ä—è–¥", description: "7 –¥–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫", icon: "üî•" },
                { id: "perfectionist", title: "–ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç", description: "95+ –±–∞–ª–ª–æ–≤ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏", icon: "‚≠ê" },
                { id: "marathon", title: "–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü", description: "50 —Å–µ—Å—Å–∏–π", icon: "üèÉ" }
            ];

            grid.innerHTML = allAchievements.map(achievement => {
                const isUnlocked = userAchievements && userAchievements[achievement.id];
                return `
                    <div class="achievement ${isUnlocked ? '' : 'locked'}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-title">${achievement.title}</div>
                        <div class="achievement-desc">${achievement.description}</div>
                    </div>
                `;
            }).join('');
        }

        async function renderHistory() {
            const container = document.getElementById('sessionsHistory');
            const sessions = await userManager.getSessionHistory(10);

            // Store in cache
            sessionsCache = sessions;

            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <h3>–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
                        <p>–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–¥–µ—Å—å</p>
                        <a href="scenarios.html" class="btn-primary">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = sessions.map((session, index) => `
                <div class="session-card">
                    <div class="session-info">
                        <h3>–°—Ü–µ–Ω–∞—Ä–∏–π: ${session.scenarioId}</h3>
                        <p>${new Date(session.completedAt.seconds * 1000).toLocaleString('ru-RU')}</p>
                        <p>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${Math.round(session.duration / 60000)} –º–∏–Ω</p>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="viewSessionAnalysis(${index})"
                                    style="padding: 8px 16px; background: #667eea; color: white;
                                           border: none; border-radius: 6px; cursor: pointer; font-size: 14px; flex: 1;">
                                üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∞–ª–∏–∑
                            </button>
                            <button onclick="deleteSession('${session.id}')"
                                    style="padding: 8px 16px; background: #ef4444; color: white;
                                           border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                    <div class="session-score">${session.score}</div>
                </div>
            `).join('');
        }

        async function saveSettings() {
            const newName = document.getElementById('displayName').value;
            await userManager.updateProfile({ displayName: newName });
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! ‚úÖ');
            renderDashboard();
        }

        async function handleLogout() {
            await userManager.logout();
            window.location.href = 'auth.html';
        }

        // Delete session
        async function deleteSession(sessionId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–ø—ã—Ç–∫—É?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }

            try {
                const result = await userManager.deleteSession(sessionId);

                if (result.success) {
                    alert('‚úÖ –ü–æ–ø—ã—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
                    // Refresh dashboard
                    await renderDashboard();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
                console.error('Delete error:', error);
            }
        }

        // View detailed session analysis
        function viewSessionAnalysis(index) {
            const session = sessionsCache[index];
            if (!session) {
                alert('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }
            const analysis = session.aiAnalysis || {};
            const score = session.score || 0;

            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); color: white;
                display: flex; align-items: center; justify-content: center;
                z-index: 10000; overflow-y: auto; padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border-radius: 20px; padding: 40px; max-width: 700px; width: 100%;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative;">

                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()"
                            style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2);
                                   border: none; color: white; font-size: 24px; width: 40px; height: 40px;
                                   border-radius: 50%; cursor: pointer;">‚úï</button>

                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 10px;">
                            ${new Date(session.completedAt.seconds * 1000).toLocaleString('ru-RU')}
                        </div>
                        <h1 style="font-size: 32px; margin: 10px 0; font-weight: 700;">
                            ${session.scenarioId || '–°—Ü–µ–Ω–∞—Ä–∏–π'}
                        </h1>
                        <div style="font-size: 48px; font-weight: 800; margin: 20px 0;">
                            ${score}/100
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center;">
                            <span style="font-size: 24px; margin-right: 10px;">üí¨</span>
                            –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞
                        </h3>
                        <p style="margin: 0; line-height: 1.6; font-size: 16px;">
                            ${analysis.feedback || '–ê–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}
                        </p>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center;">
                            <span style="font-size: 24px; margin-right: 10px;">‚úÖ</span>
                            –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Ö–æ—Ä–æ—à–æ
                        </h3>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            ${(analysis.good_points || ['–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç']).map(point =>
                                `<li style="margin-bottom: 8px;">${point}</li>`
                            ).join('')}
                        </ul>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center;">
                            <span style="font-size: 24px; margin-right: 10px;">‚ö†Ô∏è</span>
                            –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å
                        </h3>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            ${(analysis.bad_points || ['–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç']).map(point =>
                                `<li style="margin-bottom: 8px;">${point}</li>`
                            ).join('')}
                        </ul>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center;">
                            <span style="font-size: 24px; margin-right: 10px;">üí°</span>
                            –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                        </h3>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            ${(analysis.recommendations || ['–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è']).map(rec =>
                                `<li style="margin-bottom: 8px;">${rec}</li>`
                            ).join('')}
                        </ul>
                    </div>

                    ${analysis.skills ? `
                    <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 20px;">üìä –û—Ü–µ–Ω–∫–∞ –Ω–∞–≤—ã–∫–æ–≤</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            ${Object.entries(analysis.skills).map(([skill, value]) => {
                                const skillNames = {
                                    empathy: '–≠–º–ø–∞—Ç–∏—è',
                                    conflictResolution: '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤',
                                    boundaryKeeping: '–ì—Ä–∞–Ω–∏—Ü—ã',
                                    patience: '–¢–µ—Ä–ø–µ–Ω–∏–µ'
                                };
                                return `
                                    <div>
                                        <div style="margin-bottom: 5px;">${skillNames[skill] || skill}</div>
                                        <div style="background: rgba(0,0,0,0.3); border-radius: 10px; height: 12px; overflow: hidden;">
                                            <div style="background: linear-gradient(90deg, #4ade80, #22c55e);
                                                       height: 100%; width: ${value}%; border-radius: 10px;"></div>
                                        </div>
                                        <div style="font-size: 14px; margin-top: 3px; opacity: 0.8;">${value}/100</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
    </script>
</body>

</html>