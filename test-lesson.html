<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Lesson Flow | Virtual Pedagogue</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4f46e5, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p {
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .btn {
            display: inline-block;
            padding: 16px 32px;
            background: linear-gradient(135deg, #4f46e5, #8b5cf6);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        input,
        textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .step {
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            margin-bottom: 15px;
            display: none;
        }

        .step.active {
            display: block;
        }

        .step-indicator {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .step-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #6b7280;
        }

        .step-dot.active {
            background: linear-gradient(135deg, #4f46e5, #8b5cf6);
            color: white;
        }

        .step-dot.completed {
            background: #10b981;
            color: white;
        }

        .result {
            padding: 15px;
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            background: #f0fdf4;
            border-left-color: #10b981;
        }

        .score {
            font-size: 48px;
            font-weight: 800;
            color: #4f46e5;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1>üéØ –¢–µ—Å—Ç–æ–≤—ã–π –£—Ä–æ–∫</h1>
            <p>–ü—Ä–æ–π–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª: —É—Ä–æ–∫ ‚Üí AI –∞–Ω–∞–ª–∏–∑ ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –ø—Ä–æ—Å–º–æ—Ç—Ä –≤ Dashboard</p>

            <div class="step-indicator">
                <div class="step-dot active" id="dot1">1</div>
                <div class="step-dot" id="dot2">2</div>
                <div class="step-dot" id="dot3">3</div>
                <div class="step-dot" id="dot4">4</div>
            </div>

            <!-- Step 1: Start Lesson -->
            <div id="step1" class="step active">
                <h2>–®–∞–≥ 1: –ù–∞—á–∞—Ç—å —É—Ä–æ–∫</h2>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</p>
                <div class="input-group">
                    <label>–°—Ü–µ–Ω–∞—Ä–∏–π:</label>
                    <select id="scenarioSelect"
                        style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 10px;">
                        <option value="first-day">–ü–µ—Ä–≤—ã–π –î–µ–Ω—å (–ù–æ–≤–∏—á–æ–∫)</option>
                        <option value="difficult-class">–¢—Ä—É–¥–Ω—ã–π –ö–ª–∞—Å—Å (–°–ª–æ–∂–Ω—ã–π)</option>
                        <option value="phone-incident">–£—á–µ–Ω–∏–∫ —Å –¢–µ–ª–µ—Ñ–æ–Ω–æ–º (–°—Ä–µ–¥–Ω–∏–π)</option>
                        <option value="exam-stress">–°—Ç—Ä–µ—Å—Å –ü–µ—Ä–µ–¥ –≠–∫–∑–∞–º–µ–Ω–æ–º (–°—Ä–µ–¥–Ω–∏–π)</option>
                        <option value="after-holidays">–ü–æ—Å–ª–µ –ö–∞–Ω–∏–∫—É–ª (–ù–æ–≤–∏—á–æ–∫)</option>
                        <option value="leader-conflict">–ö–æ–Ω—Ñ–ª–∏–∫—Ç –õ–∏–¥–µ—Ä–æ–≤ (–°–ª–æ–∂–Ω—ã–π)</option>
                    </select>
                </div>
                <button class="btn" onclick="startLesson()">üöÄ –ù–∞—á–∞—Ç—å —É—Ä–æ–∫</button>
            </div>

            <!-- Step 2: Conduct Lesson -->
            <div id="step2" class="step">
                <h2>–®–∞–≥ 2: –ü—Ä–æ–≤–µ–¥–∏—Ç–µ —É—Ä–æ–∫</h2>
                <p><strong>–°—Ü–µ–Ω–∞—Ä–∏–π:</strong> <span id="currentScenario"></span></p>
                <p style="background: #fef3c7; padding: 12px; border-radius: 8px; font-size: 14px;">
                    üìñ <strong>–°–∏—Ç—É–∞—Ü–∏—è:</strong> –í –∫–ª–∞—Å—Å–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–µ—Ä–µ–±–∏–≤–∞—é—Ç. –í–∞—à–∞
                    –∑–∞–¥–∞—á–∞ - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Ä–æ–∫.
                </p>

                <div class="input-group">
                    <label>–í–∞—à–∞ —Ä–µ–ø–ª–∏–∫–∞ –∫–∞–∫ —É—á–∏—Ç–µ–ª—è:</label>
                    <textarea id="teacherMessage" rows="4"
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–†–µ–±—è—Ç–∞, –¥–∞–≤–∞–π—Ç–µ —É–≤–∞–∂–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –∏ —Å–ª—É—à–∞—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ...'"></textarea>
                </div>
                <button class="btn" onclick="completeLesson()">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫</button>
            </div>

            <!-- Step 3: AI Analysis -->
            <div id="step3" class="step">
                <h2>–®–∞–≥ 3: AI –ê–Ω–∞–ª–∏–∑</h2>
                <p>AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à —É—Ä–æ–∫...</p>
                <div id="analysisResult"></div>
                <button class="btn" onclick="saveResults()" id="saveBtn" style="display: none;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤
                    –ø—Ä–æ—Ñ–∏–ª—å</button>
            </div>

            <!-- Step 4: View Dashboard -->
            <div id="step4" class="step">
                <h2>–®–∞–≥ 4: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! üéâ</h2>
                <div class="result success">
                    <strong>‚úÖ –°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ Firebase!</strong>
                    <p style="margin-top: 10px;">–í–∞—à–∏ –Ω–∞–≤—ã–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–ø–∏—Å–∞–Ω.</p>
                </div>
                <a href="dashboard.html" class="btn">üìä –û—Ç–∫—Ä—ã—Ç—å Dashboard</a>
                <button class="btn" onclick="location.reload()" style="margin-left: 10px; background: #6b7280;">üîÑ
                    –ü—Ä–æ–π—Ç–∏ –µ—â–µ —Ä–∞–∑</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB7SBp_tDfeumEjJ6l8QpnamHeXA5OiWyg",
            authDomain: "test-89bad.firebaseapp.com",
            projectId: "test-89bad",
            storageBucket: "test-89bad.firebasestorage.app",
            messagingSenderId: "798844876458",
            appId: "1:798844876458:web:fa13cdaf2eec1a43ffc2d3"
        };
    </script>

    <script src="user-manager.js"></script>
    <script src="ai-client.js"></script>

    <script>
        let sessionStartTime;
        let currentScenario;
        let analysisData = null;

        // Initialize
        userManager.init(firebaseConfig);

        // Check auth
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!');
                window.location.href = 'auth.html';
            }
        });

        function startLesson() {
            sessionStartTime = Date.now();
            currentScenario = document.getElementById('scenarioSelect').value;

            document.getElementById('currentScenario').textContent =
                document.getElementById('scenarioSelect').options[document.getElementById('scenarioSelect').selectedIndex].text;

            goToStep(2);
        }

        async function completeLesson() {
            const teacherMessage = document.getElementById('teacherMessage').value;

            if (!teacherMessage.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ä–µ–ø–ª–∏–∫—É!');
                return;
            }

            goToStep(3);

            // Simulate AI analysis
            document.getElementById('analysisResult').innerHTML = '<p>‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...</p>';

            try {
                // Try to call real AI if backend is running, otherwise use mock
                let analysis;
                try {
                    analysis = await aiClient.analyzeMessage(
                        teacherMessage,
                        '–ü—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä',
                        '–°–ª–æ–∂–Ω—ã–π –∫–ª–∞—Å—Å'
                    );
                } catch (error) {
                    console.log('AI backend unavailable, using mock data');
                    // Mock analysis
                    analysis = {
                        score: Math.floor(Math.random() * 30) + 70, // 70-100
                        feedback: "–•–æ—Ä–æ—à–∏–π –ø–æ–¥—Ö–æ–¥! –í—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ –ø—Ä–æ—è–≤–∏–ª–∏ —ç–º–ø–∞—Ç–∏—é.",
                        tone: "positive",
                        skills: {
                            empathy: Math.floor(Math.random() * 20) + 70,
                            assertiveness: Math.floor(Math.random() * 20) + 65,
                            professionalism: Math.floor(Math.random() * 20) + 75
                        },
                        suggestions: [
                            "–ú–æ–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã",
                            "–û—Ç–ª–∏—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏—è"
                        ]
                    };
                }

                analysisData = analysis;

                // Display results
                const resultHTML = `
                    <div class="score">${analysis.score}</div>
                    <div class="result">
                        <strong>üí¨ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:</strong>
                        <p>${analysis.feedback}</p>
                    </div>
                    <div class="result">
                        <strong>üéØ –ù–∞–≤—ã–∫–∏:</strong>
                        <p>–≠–º–ø–∞—Ç–∏—è: ${analysis.skills.empathy}</p>
                        <p>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${analysis.skills.assertiveness || analysis.skills.conflictResolution || 70}</p>
                        <p>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º: ${analysis.skills.professionalism || analysis.skills.boundaryKeeping || 75}</p>
                    </div>
                    ${analysis.suggestions ? `
                        <div class="result">
                            <strong>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong>
                            <ul style="margin-left: 20px;">
                                ${analysis.suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;

                document.getElementById('analysisResult').innerHTML = resultHTML;
                document.getElementById('saveBtn').style.display = 'inline-block';

            } catch (error) {
                document.getElementById('analysisResult').innerHTML =
                    `<div class="result" style="background: #fee2e2; border-left-color: #ef4444;">
                        <strong>‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞</strong>
                        <p>${error.message}</p>
                    </div>`;
            }
        }

        async function saveResults() {
            try {
                const duration = Date.now() - sessionStartTime;

                const sessionData = {
                    scenarioId: currentScenario,
                    startedAt: new Date(sessionStartTime),
                    duration: duration,
                    score: analysisData.score,
                    mistakesCount: 0,
                    skillsGained: {
                        empathy: analysisData.skills.empathy,
                        conflictResolution: analysisData.skills.assertiveness || analysisData.skills.conflictResolution || 70,
                        boundaryKeeping: analysisData.skills.professionalism || analysisData.skills.boundaryKeeping || 75,
                        patience: Math.floor(Math.random() * 20) + 70
                    },
                    conversationLength: 1,
                    aiAnalysis: analysisData
                };

                await userManager.saveSessionResults(sessionData);

                goToStep(4);

            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            }
        }

        function goToStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));

            // Show target step
            document.getElementById('step' + stepNumber).classList.add('active');

            // Update step indicator
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById('dot' + i);
                dot.classList.remove('active', 'completed');

                if (i < stepNumber) {
                    dot.classList.add('completed');
                } else if (i === stepNumber) {
                    dot.classList.add('active');
                }
            }
        }
    </script>
</body>

</html>