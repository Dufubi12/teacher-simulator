# User Progress System - Firebase Configuration

## Firestore Database Schema

```javascript
// Collection: users
users/
  {userId}/ // Auto-generated by Firebase Auth
    
    // Profile Information
    profile: {
      email: string,
      displayName: string,
      photoURL: string | null,
      createdAt: timestamp,
      lastLoginAt: timestamp,
      role: "student" | "teacher" | "admin"
    },
    
    // Progress Tracking
    progress: {
      totalSessions: number,
      completedScenarios: number,
      averageScore: number,
      totalTimeSpent: number, // in seconds
      streak: number, // days in a row
      lastSessionDate: timestamp
    },
    
    // Skills Development (0-100 for each)
    skills: {
      empathy: number,
      conflictResolution: number,
      boundaryKeeping: number,
      patience: number
    },
    
    // Achievements
    achievements: {
      [achievementId]: {
        unlockedAt: timestamp,
        title: string,
        description: string
      }
    },
    
    // Session History (subcollection)
    sessions/ (subcollection)
      {sessionId}/
        scenarioId: string,
        startedAt: timestamp,
        completedAt: timestamp,
        duration: number,
        score: number,
        mistakesCount: number,
        skillsGained: {
          empathy: number,
          conflictResolution: number,
          boundaryKeeping: number,
          patience: number
        },
        conversationLength: number,
        aiAnalysis: object // from AI backend
```

## Achievements Definitions

```javascript
const ACHIEVEMENTS = {
  // Beginner
  "first_session": {
    id: "first_session",
    title: "ÐŸÐµÑ€Ð²Ñ‹Ð¹ ÑˆÐ°Ð³",
    description: "Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚Ðµ Ð¿ÐµÑ€Ð²ÑƒÑŽ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÑƒ",
    icon: "ðŸŽ“",
    requirement: (user) => user.progress.totalSessions >= 1
  },
  
  "empathy_master": {
    id: "empathy_master",
    title: "ÐœÐ°ÑÑ‚ÐµÑ€ ÑÐ¼Ð¿Ð°Ñ‚Ð¸Ð¸",
    description: "Ð”Ð¾ÑÑ‚Ð¸Ð³Ð½Ð¸Ñ‚Ðµ 80+ Ð±Ð°Ð»Ð»Ð¾Ð² Ð² ÑÐ¼Ð¿Ð°Ñ‚Ð¸Ð¸",
    icon: "â¤ï¸",
    requirement: (user) => user.skills.empathy >= 80
  },
  
  "patient_teacher": {
    id: "patient_teacher",
    title: "Ð¢ÐµÑ€Ð¿ÐµÐ»Ð¸Ð²Ñ‹Ð¹ Ð¿ÐµÐ´Ð°Ð³Ð¾Ð³",
    description: "Ð”Ð¾ÑÑ‚Ð¸Ð³Ð½Ð¸Ñ‚Ðµ 90+ Ð±Ð°Ð»Ð»Ð¾Ð² Ð² Ñ‚ÐµÑ€Ð¿ÐµÐ½Ð¸Ð¸",
    icon: "ðŸ§˜",
    requirement: (user) => user.skills.patience >= 90
  },
  
  "conflict_resolver": {
    id: "conflict_resolver",
    title: "ÐŸÐµÑ€ÐµÐ³Ð¾Ð²Ð¾Ñ€Ñ‰Ð¸Ðº",
    description: "Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ 10 ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð½Ñ‹Ñ… ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸Ð¹",
    icon: "ðŸ¤",
    requirement: (user) => user.progress.completedScenarios >= 10
  },
  
  "week_streak": {
    id: "week_streak",
    title: "ÐÐµÐ´ÐµÐ»Ñ Ð¿Ð¾Ð´Ñ€ÑÐ´",
    description: "Ð¢Ñ€ÐµÐ½Ð¸Ñ€ÑƒÐ¹Ñ‚ÐµÑÑŒ 7 Ð´Ð½ÐµÐ¹ Ð¿Ð¾Ð´Ñ€ÑÐ´",
    icon: "ðŸ”¥",
    requirement: (user) => user.progress.streak >= 7
  },
  
  "perfectionist": {
    id: "perfectionist",
    title: "ÐŸÐµÑ€Ñ„ÐµÐºÑ†Ð¸Ð¾Ð½Ð¸ÑÑ‚",
    description: "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ 95+ Ð±Ð°Ð»Ð»Ð¾Ð² Ð² ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¸",
    icon: "â­",
    requirement: (session) => session.score >= 95
  },
  
  "marathon": {
    id: "marathon",
    title: "ÐœÐ°Ñ€Ð°Ñ„Ð¾Ð½ÐµÑ†",
    description: "Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚Ðµ 50 ÑÐµÑÑÐ¸Ð¹",
    icon: "ðŸƒ",
    requirement: (user) => user.progress.totalSessions >= 50
  }
};
```

## Firebase Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users can only read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Sessions subcollection
      match /sessions/{sessionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Public leaderboard (read-only for all authenticated users)
    match /leaderboard/{entry} {
      allow read: if request.auth != null;
      allow write: if false; // Only backend can write
    }
  }
}
```

## Initial User Document Template

```javascript
function createInitialUserDoc(userId, email, displayName) {
  return {
    profile: {
      email: email,
      displayName: displayName || email.split('@')[0],
      photoURL: null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
      role: "student"
    },
    progress: {
      totalSessions: 0,
      completedScenarios: 0,
      averageScore: 0,
      totalTimeSpent: 0,
      streak: 0,
      lastSessionDate: null
    },
    skills: {
      empathy: 0,
      conflictResolution: 0,
      boundaryKeeping: 0,
      patience: 0
    },
    achievements: {}
  };
}
```

## Skill Calculation Logic

```javascript
/**
 * Update user skills based on session results
 * Uses weighted average with more weight on recent sessions
 */
function updateSkills(currentSkills, sessionSkills, sessionCount) {
  const RECENT_WEIGHT = 0.3; // 30% weight on current session
  const HISTORY_WEIGHT = 0.7; // 70% weight on history
  
  return {
    empathy: Math.round(
      currentSkills.empathy * HISTORY_WEIGHT + 
      sessionSkills.empathy * RECENT_WEIGHT
    ),
    conflictResolution: Math.round(
      currentSkills.conflictResolution * HISTORY_WEIGHT + 
      sessionSkills.conflictResolution * RECENT_WEIGHT
    ),
    boundaryKeeping: Math.round(
      currentSkills.boundaryKeeping * HISTORY_WEIGHT + 
      sessionSkills.boundaryKeeping * RECENT_WEIGHT
    ),
    patience: Math.round(
      currentSkills.patience * HISTORY_WEIGHT + 
      sessionSkills.patience * RECENT_WEIGHT
    )
  };
}

/**
 * Calculate streak (consecutive days)
 */
function calculateStreak(lastSessionDate) {
  if (!lastSessionDate) return 1;
  
  const now = new Date();
  const last = lastSessionDate.toDate();
  const daysDiff = Math.floor((now - last) / (1000 * 60 * 60 * 24));
  
  if (daysDiff === 0) {
    // Same day - keep current streak
    return null; // Don't update
  } else if (daysDiff === 1) {
    // Consecutive day - increment
    return 'increment';
  } else {
    // Broke streak - reset to 1
    return 1;
  }
}
```
