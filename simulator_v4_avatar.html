<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä v4.0 (Avatar Integrated) | Virtual Pedagogue</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Three.js Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>

    <!-- Analytics Configuration -->
    <script>
        window.ANALYTICS_CONFIG = {
            ga4MeasurementId: 'G-XXXXXXXXXX',
            yandexMetrikaId: '12345678'
        };
    </script>
    <script src="analytics.js"></script>

    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- AVATAR SCENE STYLES --- */
        #avatar-scene {
            height: 160px;
            background: radial-gradient(circle at center, #ffffff 0%, #F7F5F2 70%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        #avatar-scene.talking {
            background: radial-gradient(circle at center, #fef3c7 0%, #fde68a 70%);
            box-shadow: inset 0 0 30px rgba(251, 191, 36, 0.3);
        }

        /* Avatar Animation States */
        #avatar-scene.nod {
            animation: nodAnimation 0.6s ease-in-out;
        }

        #avatar-scene.thinking {
            animation: thinkingAnimation 1.5s ease-in-out infinite;
        }

        #avatar-scene.shake-head {
            animation: shakeHeadAnimation 0.6s ease-in-out;
        }

        #avatar-scene.positive-glow {
            background: radial-gradient(circle at center, #d1fae5 0%, #a7f3d0 70%);
            box-shadow: inset 0 0 40px rgba(16, 185, 129, 0.4);
            animation: glowAnimation 0.8s ease-in-out;
        }

        #avatar-scene.negative-glow {
            background: radial-gradient(circle at center, #fee2e2 0%, #fecaca 70%);
            box-shadow: inset 0 0 40px rgba(239, 68, 68, 0.4);
            animation: glowAnimation 0.8s ease-in-out;
        }

        /* Keyframe Animations */
        @keyframes nodAnimation {

            0%,
            100% {
                transform: translateY(0);
            }

            25% {
                transform: translateY(-8px);
            }

            50% {
                transform: translateY(0);
            }

            75% {
                transform: translateY(-4px);
            }
        }

        @keyframes shakeHeadAnimation {

            0%,
            100% {
                transform: translateX(0);
            }

            15% {
                transform: translateX(-10px);
            }

            30% {
                transform: translateX(10px);
            }

            45% {
                transform: translateX(-10px);
            }

            60% {
                transform: translateX(10px);
            }

            75% {
                transform: translateX(-5px);
            }
        }

        @keyframes thinkingAnimation {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.02);
                opacity: 0.9;
            }
        }

        @keyframes glowAnimation {

            0%,
            100% {
                box-shadow: inset 0 0 40px rgba(16, 185, 129, 0.4);
            }

            50% {
                box-shadow: inset 0 0 60px rgba(16, 185, 129, 0.6);
            }
        }

        /* Avatar Toggle Button */
        .avatar-toggle-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .avatar-toggle-btn:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: scale(1.1);
        }

        .avatar-toggle-btn i {
            color: #6b7280;
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        /* Collapsed state */
        #avatar-scene.collapsed {
            height: 60px !important;
            min-height: 60px !important;
        }

        #avatar-scene.collapsed .avatar-toggle-btn i {
            transform: rotate(180deg);
        }

        .avatar-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary, #4f46e5);
            backdrop-filter: blur(4px);
            z-index: 10;
            transition: all 0.3s ease;
        }

        /* Student Selection Screen */
        #studentSelection {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        #studentSelection.hidden {
            display: none;
        }

        .selection-container {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }

        .selection-title {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            color: #1f2937;
        }

        .selection-subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            max-height: 450px;
            overflow-y: auto;
            padding: 10px;
        }

        .student-checkbox {
            position: relative;
        }

        .student-checkbox input {
            position: absolute;
            opacity: 0;
        }

        .student-option {
            background: #f9fafb;
            border: 3px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .student-checkbox input:checked+.student-option {
            border-color: #4f46e5;
            background: #eef2ff;
            transform: scale(1.05);
        }

        .student-option-emoji {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .student-option-name {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .student-option-type {
            font-size: 10px;
            color: #9ca3af;
        }

        .selection-summary {
            text-align: center;
            padding: 15px;
            background: #f3f4f6;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .start-lesson-btn {
            width: 100%;
            padding: 16px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .start-lesson-btn:hover:not(:disabled) {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .start-lesson-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        /* Save Scenario Modal */
        #saveScenarioModal .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
        }

        #saveScenarioModal input[type="text"],
        #saveScenarioModal textarea {
            font-family: 'Inter', sans-serif;
        }

        #saveScenarioModal input[type="radio"] {
            display: none;
        }

        #saveScenarioModal input[type="radio"]:checked + span {
            border: 2px solid currentColor;
            font-weight: 700;
        }

        .student-preview-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            color: #374151;
        }

        /* Header */
        .header {
            background: white;
            padding: 12px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .back-link {
            text-decoration: none;
            color: #4f46e5;
            font-weight: 600;
        }

        .header-info {
            flex: 1;
            text-align: center;
            font-weight: 600;
            color: #1f2937;
        }

        .end-lesson-btn {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .end-lesson-btn:hover {
            background: #dc2626;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 4000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: 700;
            margin: 0 auto 15px;
        }

        .score-label {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
            color: #059669;
        }

        .analysis-section {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 12px;
        }

        .analysis-section.good {
            background: #d1fae5;
            border-left: 4px solid #10b981;
        }

        .analysis-section.bad {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .analysis-section.recommendations {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
        }

        .analysis-section h3 {
            font-size: 18px;
            margin-bottom: 12px;
        }

        .analysis-section ul {
            list-style: none;
            padding-left: 0;
        }

        .analysis-section li {
            padding: 6px 0;
            font-size: 14px;
        }

        .analysis-section li:before {
            content: "‚Ä¢ ";
            font-weight: bold;
            margin-right: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #4f46e5;
        }

        .stat-label {
            font-size: 13px;
            color: #6b7280;
            margin-top: 5px;
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .classroom-view {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            overflow-y: auto;
        }

        .classroom-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .student-card {
            background: white;
            padding: 12px 8px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.2s;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .student-card.speaking {
            border: 3px solid #fbbf24;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.6);
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
            }

            50% {
                box-shadow: 0 0 0 15px rgba(251, 191, 36, 0);
            }
        }

        .student-emoji {
            font-size: 36px;
            margin-bottom: 5px;
        }

        .student-name {
            font-weight: 600;
            font-size: 12px;
        }

        .student-type {
            font-size: 10px;
            color: #9ca3af;
            margin-top: 2px;
        }

        /* Chat */
        .chat-panel {
            width: 480px;
            background: white;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e5e7eb;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            background: #f9fafb;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 85%;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.student {
            align-self: flex-start;
            background: #f3f4f6;
            color: #1f2937;
        }

        .message.teacher {
            align-self: flex-end;
            background: #4f46e5;
            color: white;
        }

        .message.system {
            align-self: center;
            background: #fef3c7;
            color: #92400e;
            font-size: 12px;
            font-weight: 500;
        }

        .message.hint {
            align-self: center;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            font-size: 13px;
            font-weight: 600;
            border-left: 3px solid #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
            animation: slideIn 0.3s ease;
        }

        .message.hint-success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border-left-color: #10b981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }

        .message.hint-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border-left-color: #f59e0b;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
        }

        .message.hint-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border-left-color: #ef4444;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }

        .message.hint-info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border-left-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }

        input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }

        input:focus {
            border-color: #4f46e5;
        }

        button {
            padding: 10px 20px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            background: #4338ca;
        }

        /* Voice Input Button */
        .voice-btn {
            padding: 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 600;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .voice-btn:hover {
            background: #059669;
        }

        .voice-btn.recording {
            background: #ef4444;
            animation: pulse-record 1.5s infinite;
        }

        @keyframes pulse-record {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        /* Hints Panel - NOW AS SEPARATE RIGHT SIDEBAR */
        .hints-panel {
            width: 320px;
            background: white;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .hints-header {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            background: #f9fafb;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hints-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hints-content:empty::before {
            content: '–ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...';
            color: #9ca3af;
            font-size: 13px;
            text-align: center;
            padding: 20px;
        }

        .hint-item {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.4;
            animation: slideInHint 0.3s ease;
            border-left: 4px solid;
        }

        @keyframes slideInHint {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .hint-item.hint-success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #064e3b;
            border-left-color: #10b981;
            border-left-width: 5px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            font-weight: 500;
        }

        .hint-item.hint-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #78350f;
            border-left-color: #f59e0b;
            border-left-width: 5px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            font-weight: 500;
        }

        .hint-item.hint-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #7f1d1d;
            border-left-color: #ef4444;
            border-left-width: 5px;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            font-weight: 500;
            animation: slideInHint 0.3s ease, pulseHintError 2s ease-in-out 3;
        }

        .hint-item.hint-info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e3a8a;
            border-left-color: #3b82f6;
            border-left-width: 5px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            font-weight: 500;
        }

        /* Pulse animation for new hints */
        .hint-item.new-hint {
            animation: slideInHint 0.3s ease, pulseNewHint 1.5s ease-in-out 2;
        }

        @keyframes pulseNewHint {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            }

            50% {
                transform: scale(1.02);
                box-shadow: 0 4px 16px rgba(59, 130, 246, 0.5);
            }
        }

        @keyframes pulseHintError {

            0%,
            100% {
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            }

            50% {
                box-shadow: 0 4px 16px rgba(239, 68, 68, 0.6);
            }
        }
    </style>
</head>

<body>
    <!-- Student Selection -->
    <div id="studentSelection">
        <div class="selection-container">
            <h1 class="selection-title">üé≠ –í—ã–±–µ—Ä–∏—Ç–µ –£—á–µ–Ω–∏–∫–æ–≤</h1>
            <p class="selection-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —É—á–µ–Ω–∏–∫–æ–≤ –¥–ª—è —É—Ä–æ–∫–∞</p>

            <div class="students-grid" id="studentsGrid"></div>

            <div class="selection-summary">
                –í—ã–±—Ä–∞–Ω–æ: <span id="selectedCount">0</span> / 15
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="start-lesson-btn" id="startBtn" disabled style="flex: 1;">
                    <i class="fas fa-play-circle"></i> –ù–∞—á–∞—Ç—å –£—Ä–æ–∫
                </button>
                <button class="start-lesson-btn" id="saveScenarioBtn" disabled
                    style="flex: 1; background: #10b981;" onclick="openSaveScenarioModal()">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –°—Ü–µ–Ω–∞—Ä–∏–π
                </button>
            </div>
        </div>
    </div>

    <!-- Save Scenario Modal -->
    <div id="saveScenarioModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h2 style="margin-bottom: 20px; color: #1f2937;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –°—Ü–µ–Ω–∞—Ä–∏–π</h2>

            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #374151;">
                    –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è:
                </label>
                <input type="text" id="scenarioTitle"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–ª–æ–∂–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å"
                    style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #374151;">
                    –û–ø–∏—Å–∞–Ω–∏–µ:
                </label>
                <textarea id="scenarioDescription" rows="3"
                    placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è..."
                    style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">
                    –°–ª–æ–∂–Ω–æ—Å—Ç—å:
                </label>
                <div style="display: flex; gap: 10px;">
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="difficulty" value="easy" style="margin-right: 5px;">
                        <span style="padding: 8px 12px; background: #d1fae5; color: #065f46; border-radius: 6px; display: inline-block; width: 100%; text-align: center; font-size: 13px;">
                            üü¢ –õ–µ–≥–∫–∏–π
                        </span>
                    </label>
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="difficulty" value="medium" checked style="margin-right: 5px;">
                        <span style="padding: 8px 12px; background: #fef3c7; color: #92400e; border-radius: 6px; display: inline-block; width: 100%; text-align: center; font-size: 13px;">
                            üü° –°—Ä–µ–¥–Ω–∏–π
                        </span>
                    </label>
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="difficulty" value="hard" style="margin-right: 5px;">
                        <span style="padding: 8px 12px; background: #fee2e2; color: #991b1b; border-radius: 6px; display: inline-block; width: 100%; text-align: center; font-size: 13px;">
                            üî¥ –°–ª–æ–∂–Ω—ã–π
                        </span>
                    </label>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="useForAssessment" checked
                        style="margin-right: 8px; width: 18px; height: 18px;">
                    <span style="font-size: 14px; color: #374151;">
                        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                    </span>
                </label>
            </div>

            <div style="padding: 15px; background: #f9fafb; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">
                    –í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∏:
                </div>
                <div id="selectedStudentsPreview" style="display: flex; flex-wrap: wrap; gap: 6px;">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeSaveScenarioModal()"
                    style="padding: 10px 20px; background: #e5e7eb; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button onclick="saveScenario()"
                    style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal hidden">
        <div class="modal-content">
            <h2 class="modal-title">üìä –ê–Ω–∞–ª–∏–∑ –í–∞—à–µ–≥–æ –£—Ä–æ–∫–∞</h2>

            <div class="score-circle" id="scoreCircle">-</div>
            <div class="score-label" id="scoreLabel">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

            <div id="analysisContainer"></div>

            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-value" id="totalMessages">0</div>
                        <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="conflictsCount">0</div>
                        <div class="stat-label">–ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="durationStat">00:00</div>
                        <div class="stat-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="hintsReceived" style="color: #3b82f6;">0</div>
                        <div class="stat-label">–ü–æ–¥—Å–∫–∞–∑–æ–∫</div>
                    </div>
                </div>
            </div>

            <button class="start-lesson-btn" style="margin-top: 20px;" onclick="location.reload()">
                <i class="fas fa-redo"></i> –ù–∞—á–∞—Ç—å –ù–æ–≤—ã–π –£—Ä–æ–∫
            </button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <a href="index.html" class="back-link">‚Üê –ù–∞–∑–∞–¥</a>
        <div class="header-info">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ ‚Ä¢ 8 "–ë" ‚Ä¢ <span id="timer">00:00</span> ‚Ä¢ <span id="hint-counter"
                style="color: #3b82f6;">üí° 0</span></div>
        <button class="end-lesson-btn" onclick="endLesson()">
            <i class="fas fa-stop-circle"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å –£—Ä–æ–∫
        </button>
    </div>

    <!-- Main -->
    <div class="main-container">
        <div class="classroom-view">
            <div class="classroom-grid" id="classroomGrid"></div>
        </div>

        <div class="chat-panel">
            <!-- AVATAR SCENE -->
            <div id="avatar-scene">
                <div class="avatar-status">
                    <span id="status-text">EcoMentor</span>
                </div>
                <button class="avatar-toggle-btn" id="avatarToggleBtn" onclick="toggleAvatarScene()"
                    title="–°–≤–µ—Ä–Ω—É—Ç—å/–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>

            <div class="chat-header">üí¨ –î–∏–∞–ª–æ–≥ —Å –∫–ª–∞—Å—Å–æ–º</div>
            <div class="chat-messages" id="messages"></div>
            <div class="chat-input">
                <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" autocorrect="off" autocapitalize="off" />
                <button class="voice-btn" id="voiceBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">
                    <i class="fas fa-microphone"></i>
                </button>
                <button onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- Hints Panel (Right Sidebar) -->
        <div class="hints-panel">
            <div class="hints-header">
                <i class="fas fa-lightbulb" style="color: #f59e0b;"></i>
                AI –ü–æ–¥—Å–∫–∞–∑–∫–∏
            </div>
            <div class="hints-content" id="hintsPanel"></div>
        </div>
    </div>

    <script>
        // API Key - REMOVED for security (use backend API instead)
        const API_KEY = '';

        const allStudents = [
            { id: 1, name: "–ü–µ—Ç—Ä–æ–≤", type: "–ü—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä", emoji: "üòè" },
            { id: 2, name: "–°–æ–Ω—è", type: "–ê–ø–∞—Ç–∏—á–Ω–∞—è", emoji: "üò¥" },
            { id: 3, name: "–ê–Ω–Ω–∞", type: "–ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç", emoji: "üò∞" },
            { id: 4, name: "–ú–∞–∫—Å–∏–º", type: "–õ–∏–¥–µ—Ä", emoji: "üòé" },
            { id: 5, name: "–õ–∏–∑–∞", type: "–¢—Ä–µ–≤–æ–∂–Ω–∞—è", emoji: "üòü" },
            { id: 6, name: "–ê—Ä—Ç–µ–º", type: "–ö–ª–æ—É–Ω", emoji: "ü§°" },
            { id: 7, name: "–ö–∞—Ç—è", type: "–û—Ç–ª–∏—á–Ω–∏—Ü–∞", emoji: "ü§ì" },
            { id: 8, name: "–î–µ–Ω–∏—Å", type: "–°–ø–æ—Ä—Ç—Å–º–µ–Ω", emoji: "üí™" },
            { id: 9, name: "–ú–∞—à–∞", type: "–ú–µ—á—Ç–∞—Ç–µ–ª—å–Ω–∏—Ü–∞", emoji: "üå∏" },
            { id: 10, name: "–ò–≥–æ—Ä—å", type: "–•—É–ª–∏–≥–∞–Ω", emoji: "üòà" },
            { id: 11, name: "–û–ª—è", type: "–ê–∫—Ç–∏–≤–∏—Å—Ç–∫–∞", emoji: "üåü" },
            { id: 12, name: "–°–∞—à–∞", type: "–¢–∏—Ö–æ–Ω—è", emoji: "üôÇ" },
            { id: 13, name: "–í–∏–∫–∞", type: "–°–ø–ª–µ—Ç–Ω–∏—Ü–∞", emoji: "üó£Ô∏è" },
            { id: 14, name: "–ö–æ–ª—è", type: "–ë–æ—Ç–∞–Ω–∏–∫", emoji: "üìö" },
            { id: 15, name: "–î–∞—à–∞", type: "–ü–æ–ø—É–ª—è—Ä–Ω–∞—è", emoji: "üíÖ" },
            { id: 16, name: "–ö–∏—Ä–∏–ª–ª", type: "–¢–µ–ª–µ—Ñ–æ–Ω—â–∏–∫", emoji: "üì±" }
        ];

        let students = [];
        let history = [];
        let activityTimer = null;
        let silenceTimer = null;
        let lessonTime = 0; // Renamed from 'time' to avoid conflict with Three.js
        let lastTeacherMessage = Date.now();
        let hintCount = 0;
        let recognition = null; // Voice recognition object

        // Session Score Tracker
        let sessionScore = {
            positiveActions: 0,    // –ü–æ—Ö–≤–∞–ª–∞, —ç–º–ø–∞—Ç–∏—è, –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
            negativeActions: 0,    // –ê–≥—Ä–µ—Å—Å–∏—è, –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ–¥–Ω–æ—Å–ª–æ–∂–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
            neutralActions: 0,     // –û–±—ã—á–Ω—ã–µ —Ä–µ–ø–ª–∏–∫–∏
            totalMessages: 0,
            conflicts: 0,          // –ö–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏
            praises: 0,            // –ü–æ—Ö–≤–∞–ª—ã
            questions: 0,          // –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
            empathy: 0,            // –≠–º–ø–∞—Ç–∏—è
            aggression: 0,         // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ —Ñ—Ä–∞–∑—ã
            difficulty: 1.0        // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (1.0 = –Ω–æ–≤–∏—á–æ–∫, 1.2 = —Å—Ä–µ–¥–Ω–∏–π, 1.5 = —ç–∫—Å–ø–µ—Ä—Ç)
        };

        // Student State Tracker (mood, understanding, engagement)
        let studentStates = {};

        // Initialize student state
        function initStudentState(studentId) {
            studentStates[studentId] = {
                mood: 5,           // 1-10 (1=–æ—á–µ–Ω—å –ø–ª–æ—Ö–æ–µ, 10=–æ—Ç–ª–∏—á–Ω–æ–µ)
                understanding: 5,  // 1-10 (1=–Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, 10=–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω–∏–º–∞–µ—Ç)
                engagement: 5,     // 1-10 (1=–Ω–µ –≤–æ–≤–ª–µ—á–µ–Ω, 10=–æ—á–µ–Ω—å –∞–∫—Ç–∏–≤–µ–Ω)
                lastInteraction: null
            };
        }

        // Update student state based on teacher's message
        function updateStudentState(studentId, teacherMessage) {
            if (!studentStates[studentId]) {
                initStudentState(studentId);
            }

            const state = studentStates[studentId];
            const lower = teacherMessage.toLowerCase();

            // Positive interactions
            if (lower.includes('–º–æ–ª–æ–¥–µ—Ü') || lower.includes('–æ—Ç–ª–∏—á–Ω–æ') || lower.includes('—É–º–Ω–∏—Ü–∞') || lower.includes('–∑–¥–æ—Ä–æ–≤–æ')) {
                state.mood = Math.min(10, state.mood + 1);
                state.engagement = Math.min(10, state.engagement + 0.5);
            }

            if (lower.includes('–ø–æ–Ω–∏–º–∞—é') || lower.includes('–¥–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä–µ–º') || lower.includes('–ø–æ–º–æ–≥—É')) {
                state.understanding = Math.min(10, state.understanding + 1);
                state.mood = Math.min(10, state.mood + 0.5);
            }

            if (lower.includes('–ø–æ—á–µ–º—É') || lower.includes('–∫–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å') || lower.includes('—á—Ç–æ —Å—á–∏—Ç–∞–µ—à—å')) {
                state.engagement = Math.min(10, state.engagement + 1);
                state.understanding = Math.min(10, state.understanding + 0.5);
            }

            // Negative interactions
            if (lower.includes('–∑–∞–∫—Ä–æ–π') || lower.includes('–≤—ã–π–¥–∏') || lower.includes('–≤–æ–Ω') || lower.includes('–∑–∞–º–æ–ª—á–∏')) {
                state.mood = Math.max(1, state.mood - 2);
                state.engagement = Math.max(1, state.engagement - 1.5);
            }

            if (lower.includes('–¥–≤–æ–π–∫–∞') || lower.includes('–ø–ª–æ—Ö–æ') || lower.includes('—É–∂–∞—Å')) {
                state.mood = Math.max(1, state.mood - 1);
                state.understanding = Math.max(1, state.understanding - 0.5);
            }

            // Ignoring student (no interaction for long time)
            if (state.lastInteraction && (Date.now() - state.lastInteraction > 120000)) { // 2 minutes
                state.engagement = Math.max(1, state.engagement - 1);
            }

            state.lastInteraction = Date.now();

            return state;
        }

        // Get mood description
        function getMoodDescription(mood) {
            if (mood >= 8) return '–æ—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ';
            if (mood >= 6) return '—Ö–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ';
            if (mood >= 4) return '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ';
            if (mood >= 2) return '–ø–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ';
            return '–æ—á–µ–Ω—å –ø–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ';
        }

        // Get understanding description
        function getUnderstandingDescription(understanding) {
            if (understanding >= 8) return '–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω–∏–º–∞–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª';
            if (understanding >= 6) return '—Ö–æ—Ä–æ—à–æ –ø–æ–Ω–∏–º–∞–µ—Ç';
            if (understanding >= 4) return '—á–∞—Å—Ç–∏—á–Ω–æ –ø–æ–Ω–∏–º–∞–µ—Ç';
            if (understanding >= 2) return '–ø–ª–æ—Ö–æ –ø–æ–Ω–∏–º–∞–µ—Ç';
            return '—Å–æ–≤—Å–µ–º –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç';
        }

        // Get engagement description
        function getEngagementDescription(engagement) {
            if (engagement >= 8) return '–æ—á–µ–Ω—å –∞–∫—Ç–∏–≤–µ–Ω';
            if (engagement >= 6) return '–≤–æ–≤–ª–µ—á–µ–Ω';
            if (engagement >= 4) return '–Ω–µ–π—Ç—Ä–∞–ª–µ–Ω';
            if (engagement >= 2) return '–æ—Ç–≤–ª–µ–∫–∞–µ—Ç—Å—è';
            return '—Å–æ–≤—Å–µ–º –Ω–µ –≤–æ–≤–ª–µ—á–µ–Ω';
        }

        // Render student selection
        function renderStudentSelection() {
            const grid = document.getElementById('studentsGrid');
            grid.innerHTML = allStudents.map(s => `
                <label class="student-checkbox">
                    <input type="checkbox" value="${s.id}" onchange="updateSelection()">
                    <div class="student-option">
                        <div class="student-option-emoji">${s.emoji}</div>
                        <div class="student-option-name">${s.name}</div>
                        <div class="student-option-type">${s.type}</div>
                    </div>
                </label>
            `).join('');
        }

        // Improved name matching function
        function findStudentByName(message, studentsList) {
            const lowerMessage = message.toLowerCase();

            // Try exact word match first (with word boundaries)
            for (let student of studentsList) {
                const namePattern = new RegExp(`\\b${student.name.toLowerCase()}\\b`, 'i');
                if (namePattern.test(lowerMessage)) {
                    return student;
                }
            }

            // Try partial match at word start (e.g., "–ú–∞–∫" matches "–ú–∞–∫—Å–∏–º")
            for (let student of studentsList) {
                const words = lowerMessage.split(/\s+/);
                for (let word of words) {
                    if (word.startsWith(student.name.toLowerCase().substring(0, 3)) && student.name.length >= 3) {
                        return student;
                    }
                }
            }

            // No match found
            return null;
        }

        function updateSelection() {
            const checkboxes = document.querySelectorAll('.student-checkbox input:checked');
            const count = checkboxes.length;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('startBtn').disabled = count < 3;
            document.getElementById('saveScenarioBtn').disabled = count < 3;
        }

        function startLesson() {
            const checkboxes = document.querySelectorAll('.student-checkbox input:checked');
            students = Array.from(checkboxes).map(cb =>
                allStudents.find(s => s.id === parseInt(cb.value))
            );

            // Initialize states for all selected students
            students.forEach(student => {
                initStudentState(student.id);
            });

            document.getElementById('studentSelection').classList.add('hidden');
            init();
        }

        // Initialize
        function init() {
            renderClassroom();
            startTimer();
            addMessage('system', '–£—Ä–æ–∫ –Ω–∞—á–∞–ª—Å—è. –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∫–ª–∞—Å—Å–æ–º! üîî');

            // Random initial event
            setTimeout(() => {
                const randomStudent = students[Math.floor(Math.random() * students.length)];
                const eventTypes = ['distraction', 'question', 'conflict', 'bored'];
                const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];
                triggerInitialEvent(randomStudent, eventType);
            }, 3000);

            // Start activity timer (60 seconds)
            startActivityTimer();

            // Start silence monitor
            startSilenceMonitor();
        }

        function renderClassroom() {
            const grid = document.getElementById('classroomGrid');
            grid.innerHTML = students.map(s => `
                <div class="student-card" id="student-${s.id}">
                    <div class="student-emoji">${s.emoji}</div>
                    <div class="student-name">${s.name}</div>
                    <div class="student-type">${s.type}</div>
                </div>
            `).join('');
        }

        function startTimer() {
            setInterval(() => {
                lessonTime++;
                const m = Math.floor(lessonTime / 60);
                const s = lessonTime % 60;
                document.getElementById('timer').textContent =
                    `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Activity timer
        function startActivityTimer() {
            activityTimer = setInterval(() => {
                const randomStudent = students[Math.floor(Math.random() * students.length)];
                triggerStudentEvent(randomStudent);
            }, 60000); // Every 60 seconds
        }

        // Silence monitor
        function startSilenceMonitor() {
            silenceTimer = setInterval(() => {
                const timeSinceLastMessage = Date.now() - lastTeacherMessage;
                if (timeSinceLastMessage > 45000 && history.length > 0) { // 45 seconds
                    triggerSilenceReaction();
                }
            }, 10000); // Check every 10 seconds
        }

        async function triggerSilenceReaction() {
            const reactors = students.filter(s =>
                s.type === '–ü—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä' || s.type === '–ê–∫—Ç–∏–≤–∏—Å—Ç–∫–∞' || s.type === '–ú–µ—á—Ç–∞—Ç–µ–ª—å–Ω–∏—Ü–∞'
            );
            if (reactors.length === 0) return;

            const reactor = reactors[Math.floor(Math.random() * reactors.length)];
            const prompt = `–¢—ã ${reactor.name}, ${reactor.type}. –£—á–∏—Ç–µ–ª—å –º–æ–ª—á–∏—Ç —É–∂–µ 45 —Å–µ–∫—É–Ω–¥. –û—Ç—Ä–µ–∞–≥–∏—Ä—É–π –Ω–∞ —ç—Ç–æ –º–æ–ª—á–∞–Ω–∏–µ (1 –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ).`;

            try {
                const response = await callAI(prompt, 50);
                addMessage('student', `${reactor.emoji} ${reactor.name}: ${response}`, reactor);
                lastTeacherMessage = Date.now(); // Reset
            } catch (e) {
                console.error(e);
            }
        }

        // Initial event
        async function triggerInitialEvent(student, type) {
            const prompts = {
                distraction: `–¢—ã ${student.name}, —É—á–µ–Ω–∏–∫ 8 –∫–ª–∞—Å—Å–∞, –ø—Å–∏—Ö–æ—Ç–∏–ø "${student.type}". –£—Ä–æ–∫ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª—Å—è, –Ω–æ —Ç—ã –æ—Ç–≤–ª–µ–∫—Å—è. –û–ø–∏—à–∏ –ö–†–ê–¢–ö–û (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ) —á—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å. –î–æ–±–∞–≤—å —Ä–µ–º–∞—Ä–∫—É –≤ —Å–∫–æ–±–∫–∞—Ö –æ—Ç –¢–†–ï–¢–¨–ï–ì–û –ª–∏—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "(—Å–º–æ—Ç—Ä–∏—Ç –≤ —Ç–µ–ª–µ—Ñ–æ–Ω)", –∞ –ù–ï "(—Å–º–æ—Ç—Ä—é –≤ —Ç–µ–ª–µ—Ñ–æ–Ω)"). –ù–ï –Ω–∞—á–∏–Ω–∞–π —Å–æ —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏.`,
                question: `–¢—ã ${student.name}, —É—á–µ–Ω–∏–∫ 8 –∫–ª–∞—Å—Å–∞, –ø—Å–∏—Ö–æ—Ç–∏–ø "${student.type}". –£—Ä–æ–∫ –Ω–∞—á–∞–ª—Å—è, —É —Ç–µ–±—è –ø–æ—è–≤–∏–ª—Å—è –≤–æ–ø—Ä–æ—Å –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ. –ó–∞–¥–∞–π –µ–≥–æ –≤ —Å—Ç–∏–ª–µ –ø–æ–¥—Ä–æ—Å—Ç–∫–∞ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ). –†–µ–º–∞—Ä–∫–∏ –≤ —Å–∫–æ–±–∫–∞—Ö ‚Äî –æ—Ç –¢–†–ï–¢–¨–ï–ì–û –ª–∏—Ü–∞. –ù–ï –Ω–∞—á–∏–Ω–∞–π —Å–æ —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏.`,
                conflict: `–¢—ã ${student.name}, —É—á–µ–Ω–∏–∫ 8 –∫–ª–∞—Å—Å–∞, –ø—Å–∏—Ö–æ—Ç–∏–ø "${student.type}". –£—Ä–æ–∫ –Ω–∞—á–∞–ª—Å—è, —Ç—ã —Ö–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å –Ω–µ–±–æ–ª—å—à—É—é –ø—Ä–æ–≤–æ–∫–∞—Ü–∏—é –∏–ª–∏ –ø–æ—à—É—Ç–∏—Ç—å. –ß—Ç–æ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å? (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å —Ä–µ–º–∞—Ä–∫–æ–π –æ—Ç –¢–†–ï–¢–¨–ï–ì–û –ª–∏—Ü–∞). –ù–ï –Ω–∞—á–∏–Ω–∞–π —Å–æ —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏.`,
                bored: `–¢—ã ${student.name}, —É—á–µ–Ω–∏–∫ 8 –∫–ª–∞—Å—Å–∞, –ø—Å–∏—Ö–æ—Ç–∏–ø "${student.type}". –£—Ä–æ–∫ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª—Å—è, —Ç–µ–±–µ —É–∂–µ —Å–∫—É—á–Ω–æ. –ü–æ–∫–∞–∂–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ–º –∏–ª–∏ —Ñ—Ä–∞–∑–æ–π (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å —Ä–µ–º–∞—Ä–∫–æ–π –æ—Ç –¢–†–ï–¢–¨–ï–ì–û –ª–∏—Ü–∞). –ù–ï –Ω–∞—á–∏–Ω–∞–π —Å–æ —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏.`
            };

            try {
                let action = await callAI(prompts[type], 80);
                action = action.replace(/^[–ê-–Ø–ÅA-Z][–∞-—è—ëa-z]+\s*:\s*/u, '').trim();
                addMessage('student', `${student.emoji} ${student.name}: ${action}`, student);
            } catch (e) {
                console.error('Initial event error:', e);
                const fallbacks = {
                    distraction: '(—Å–º–æ—Ç—Ä–∏—Ç –≤ —Ç–µ–ª–µ—Ñ–æ–Ω)',
                    question: '–ê —ç—Ç–æ –±—É–¥–µ—Ç –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π?',
                    conflict: '(—à–µ–ø—á–µ—Ç —Å–æ—Å–µ–¥—É —á—Ç–æ-—Ç–æ —Å–º–µ—à–Ω–æ–µ)',
                    bored: '(–∑–µ–≤–∞–µ—Ç)'
                };
                addMessage('student', `${student.emoji} ${student.name}: ${fallbacks[type]}`, student);
            }
        }

        // Student event
        async function triggerStudentEvent(student) {
            let prompt;
            if (student.type === '–¢–µ–ª–µ—Ñ–æ–Ω—â–∏–∫') {
                const phoneActions = [
                    '—Å–º–æ—Ç—Ä–∏—à—å –≤–∏–¥–µ–æ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ, –±–µ–∑–∑–≤—É—á–Ω–æ, –Ω–æ —è–≤–Ω–æ',
                    '–ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—à—å—Å—è —Å –∫–µ–º-—Ç–æ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ, —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥ –ø–∞—Ä—Ç–æ–π',
                    '–¥–æ—Å—Ç–∞—ë—à—å —Ç–µ–ª–µ—Ñ–æ–Ω —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —É–±—Ä–∞–ª –µ–≥–æ',
                    '—Å–º–µ—ë—à—å—Å—è –Ω–∞–¥ —á–µ–º-—Ç–æ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ, –ø—ã—Ç–∞—è—Å—å –Ω–µ –ø–æ–∫–∞–∑–∞—Ç—å',
                    '–∏–≥—Ä–∞–µ—à—å –≤ –º–æ–±–∏–ª—å–Ω—É—é –∏–≥—Ä—É, –Ω–∞–∂–∏–º–∞–µ—à—å –Ω–∞ —ç–∫—Ä–∞–Ω',
                    '—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–µ—à—å —á—Ç–æ-—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –ø—Ä—è–º–æ –Ω–∞ —É—Ä–æ–∫–µ',
                    '—Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥, –∂–¥—ë—à—å —Å–æ–æ–±—â–µ–Ω–∏–µ'
                ];
                const phoneAction = phoneActions[Math.floor(Math.random() * phoneActions.length)];
                prompt = `–¢—ã ${student.name}, —É—á–µ–Ω–∏–∫ 8 –∫–ª–∞—Å—Å–∞. –¢—ã –¢–ï–õ–ï–§–û–ù–©–ò–ö ‚Äî –≤–µ—Å—å —É—Ä–æ–∫ —Å–∏–¥–∏—à—å –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∏ —Ç–µ–±—è —ç—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–ª–æ—â–∞–µ—Ç. –ü—Ä—è–º–æ —Å–µ–π—á–∞—Å —Ç—ã ${phoneAction}. –û–ø–∏—à–∏ —ç—Ç–æ –ö–†–ê–¢–ö–û (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –≤ —Å—Ç–∏–ª–µ –ø–æ–¥—Ä–æ—Å—Ç–∫–∞. –†–µ–º–∞—Ä–∫–∏ –≤ —Å–∫–æ–±–∫–∞—Ö ‚Äî –æ—Ç –¢–†–ï–¢–¨–ï–ì–û –ª–∏—Ü–∞. –ù–ï –Ω–∞—á–∏–Ω–∞–π —Å–æ —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏.`;
            } else {
                const actions = [
                    '–¥–µ–ª–∞–µ—Ç —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ',
                    '–æ—Ç–≤–ª–µ–∫–∞–µ—Ç—Å—è',
                    '–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —É—Ä–æ–∫',
                    '–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å —Å–æ—Å–µ–¥–æ–º',
                    '–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —É—Ä–æ–∫—É'
                ];
                const randomAction = actions[Math.floor(Math.random() * actions.length)];
                prompt = `–¢—ã ${student.name}, —É—á–µ–Ω–∏–∫ 8 –∫–ª–∞—Å—Å–∞ –Ω–∞ —É—Ä–æ–∫–µ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏. –¢–≤–æ–π –ø—Å–∏—Ö–æ—Ç–∏–ø: "${student.type}". –¢—ã ${randomAction}. –û–ø–∏—à–∏ —ç—Ç–æ –ö–†–ê–¢–ö–û (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ) –≤ —Å—Ç–∏–ª–µ –ø–æ–¥—Ä–æ—Å—Ç–∫–∞. –î–æ–±–∞–≤—å —Ä–µ–º–∞—Ä–∫—É –≤ —Å–∫–æ–±–∫–∞—Ö –æ –¥–µ–π—Å—Ç–≤–∏–∏ –∏–ª–∏ —ç–º–æ—Ü–∏–∏ –æ—Ç –¢–†–ï–¢–¨–ï–ì–û –ª–∏—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "(—Å–º–æ—Ç—Ä–∏—Ç –≤ –æ–∫–Ω–æ)", –∞ –ù–ï "(—Å–º–æ—Ç—Ä—é –≤ –æ–∫–Ω–æ)"). –ù–ï –Ω–∞—á–∏–Ω–∞–π —Å–æ —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏. –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º.`;
            }

            try {
                let action = await callAI(prompt, 80);
                action = action.replace(/^[–ê-–Ø–ÅA-Z][–∞-—è—ëa-z]+\s*:\s*/u, '').trim();
                addMessage('student', `${student.emoji} ${student.name}: ${action}`, student);
            } catch (e) {
                console.error('Student event error:', e);
            }
        }

        // Send message
        async function send() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            if (!text) return;

            // Clear input IMMEDIATELY and focus
            const messageToSend = text;
            input.value = '';
            input.focus();

            addMessage('teacher', messageToSend);
            lastTeacherMessage = Date.now();

            // Analyze teacher action for scoring
            analyzeTeacherAction(messageToSend);

            // Find responder using improved name matching
            let responder = findStudentByName(messageToSend, students);
            if (!responder) responder = students[Math.floor(Math.random() * students.length)];

            // Update student state based on teacher's message
            const studentState = updateStudentState(responder.id, messageToSend);

            // Generate response with context
            setTimeout(async () => {
                // Get recent conversation context (last 3 messages)
                const recentHistory = history.slice(-6).map(m =>
                    `${m.type === 'teacher' ? '–£—á–∏—Ç–µ–ª—å' : '–£—á–µ–Ω–∏–∫'}: ${m.text}`
                ).join('\\n');

                // Personality traits for each type
                const personalities = {
                    '–ü—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä': '—Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π, –ª—é–±–∏—Ç —Å–ø–æ—Ä–∏—Ç—å, –∑–∞–¥–∞–µ—Ç –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã',
                    '–ê–ø–∞—Ç–∏—á–Ω–∞—è': '–±–µ–∑—Ä–∞–∑–ª–∏—á–Ω–∞—è, –æ—Ç–≤–µ—á–∞–µ—Ç –æ–¥–Ω–æ—Å–ª–æ–∂–Ω–æ, —á–∞—Å—Ç–æ –∑–µ–≤–∞–µ—Ç',
                    '–ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç': '—Ç—Ä–µ–≤–æ–∂–Ω–∞—è, –±–æ–∏—Ç—Å—è –æ—à–∏–±–∏—Ç—å—Å—è, –∑–∞–¥–∞–µ—Ç —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã',
                    '–õ–∏–¥–µ—Ä': '—É–≤–µ—Ä–µ–Ω–Ω—ã–π, –∞–∫—Ç–∏–≤–Ω—ã–π, –±–µ—Ä–µ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É',
                    '–¢—Ä–µ–≤–æ–∂–Ω–∞—è': '–Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–∞—è, –±–æ–∏—Ç—Å—è –æ—Ç–≤–µ—á–∞—Ç—å, –Ω–µ—Ä–≤–Ω–∏—á–∞–µ—Ç',
                    '–ö–ª–æ—É–Ω': '—à—É—Ç–∏—Ç, –æ—Ç–≤–ª–µ–∫–∞–µ—Ç –∫–ª–∞—Å—Å, –Ω–µ —Å–µ—Ä—å–µ–∑–Ω—ã–π',
                    '–û—Ç–ª–∏—á–Ω–∏—Ü–∞': '—Å—Ç–∞—Ä–∞—Ç–µ–ª—å–Ω–∞—è, –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å, –∑–Ω–∞–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª',
                    '–°–ø–æ—Ä—Ç—Å–º–µ–Ω': '—ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π, –Ω–æ –Ω–µ –æ—á–µ–Ω—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω –∫ —É—á–µ–±–µ',
                    '–ú–µ—á—Ç–∞—Ç–µ–ª—å–Ω–∏—Ü–∞': '—Ä–∞—Å—Å–µ—è–Ω–Ω–∞—è, –≤–∏—Ç–∞–µ—Ç –≤ –æ–±–ª–∞–∫–∞—Ö, —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–∞—è',
                    '–•—É–ª–∏–≥–∞–Ω': '–≥—Ä—É–±–æ–≤–∞—Ç—ã–π, –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞, –¥–µ—Ä–∑–∫–∏–π',
                    '–ê–∫—Ç–∏–≤–∏—Å—Ç–∫–∞': '—Å–æ—Ü–∏–∞–ª—å–Ω–æ –∞–∫—Ç–∏–≤–Ω–∞—è, —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è, –∑–∞—â–∏—â–∞–µ—Ç –¥—Ä—É–≥–∏—Ö',
                    '–¢–∏—Ö–æ–Ω—è': '–∑–∞—Å—Ç–µ–Ω—á–∏–≤—ã–π, –≥–æ–≤–æ—Ä–∏—Ç —Ç–∏—Ö–æ, –∏–∑–±–µ–≥–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è',
                    '–°–ø–ª–µ—Ç–Ω–∏—Ü–∞': '–ª—é–±–æ–ø—ã—Ç–Ω–∞—è, –æ–±—Å—É–∂–¥–∞–µ—Ç –¥—Ä—É–≥–∏—Ö, –±–æ–ª—Ç–ª–∏–≤–∞—è',
                    '–ë–æ—Ç–∞–Ω–∏–∫': '—É–º–Ω—ã–π, —É–≤–ª–µ—á–µ–Ω –Ω–∞—É–∫–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã',
                    '–ü–æ–ø—É–ª—è—Ä–Ω–∞—è': '–º–æ–¥–Ω–∞—è, —Å–ª–µ–¥–∏—Ç –∑–∞ —Ç—Ä–µ–Ω–¥–∞–º–∏, –Ω–µ–º–Ω–æ–≥–æ –≤—ã—Å–æ–∫–æ–º–µ—Ä–Ω–∞—è',
                    '–¢–µ–ª–µ—Ñ–æ–Ω—â–∏–∫': '–ü–û–õ–ù–û–°–¢–¨–Æ –ø–æ–≥–ª–æ—â—ë–Ω —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –≤–µ—Å—å —É—Ä–æ–∫: —Å–º–æ—Ç—Ä–∏—Ç –≤–∏–¥–µ–æ, –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è, –∏–≥—Ä–∞–µ—Ç. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —É—á–∏—Ç–µ–ª—è, —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –µ–≥–æ –æ—Ç–≤–ª–µ–∫–∞—é—Ç –æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –Ω–∞—Ö–æ–¥–∏—Ç –ª—é–±–æ–π –ø—Ä–µ–¥–ª–æ–≥ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —ç–∫—Ä–∞–Ω—É. –°—á–∏—Ç–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω –≤–∞–∂–Ω–µ–µ —É—Ä–æ–∫–∞. –£–±–∏—Ä–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω —Ç–æ–ª—å–∫–æ –ø–æ–¥ –ø—Ä—è–º—ã–º –¥–∞–≤–ª–µ–Ω–∏–µ–º –∏ —Å—Ä–∞–∑—É –¥–æ—Å—Ç–∞—ë—Ç —Å–Ω–æ–≤–∞'
                };

                const personality = personalities[responder.type] || '–æ–±—ã—á–Ω—ã–π –ø–æ–¥—Ä–æ—Å—Ç–æ–∫';

                // Build state context
                const stateContext = `
–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞:
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${getMoodDescription(studentState.mood)} (${studentState.mood}/10)
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ: ${getUnderstandingDescription(studentState.understanding)} (${studentState.understanding}/10)
- –í–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å: ${getEngagementDescription(studentState.engagement)} (${studentState.engagement}/10)`;

                const phoneContext = responder.type === '–¢–µ–ª–µ—Ñ–æ–Ω—â–∏–∫'
                    ? '\n\n–í–ê–ñ–ù–û: –¢—ã –¢–ï–õ–ï–§–û–ù–©–ò–ö. –¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Ç–µ–±—è –≤–∞–∂–Ω–µ–µ —É—Ä–æ–∫–∞. –î–∞–∂–µ –æ—Ç–≤–µ—á–∞—è —É—á–∏—Ç–µ–ª—é, —Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ—à—å –ø–æ–≥–ª—è–¥—ã–≤–∞—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω –∏–ª–∏ –Ω–µ—Ö–æ—Ç—è —É–±–∏—Ä–∞–µ—à—å —Ç–µ–ª–µ—Ñ–æ–Ω. –¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ —Ç–µ–±—è –ø—Ä–µ—Ä–≤–∞–ª–∏ ‚Äî —Ç—ã —Ä–∞–∑–¥—Ä–∞–∂—ë–Ω –∏–ª–∏ –±–µ–∑—Ä–∞–∑–ª–∏—á–µ–Ω. –¢—ã –∏—â–µ—à—å —Å–ø–æ—Å–æ–± –ø–æ—Å–∫–æ—Ä–µ–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ–ª–µ—Ñ–æ–Ω—É.'
                    : '';

                const prompt = `–¢—ã ${responder.name}, —É—á–µ–Ω–∏–∫ 8 –∫–ª–∞—Å—Å–∞. –¢–≤–æ–π –ø—Å–∏—Ö–æ—Ç–∏–ø: ${responder.type} ‚Äî ${personality}.${phoneContext}

${stateContext}

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:
${recentHistory}

–£—á–∏—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–∫–∞–∑–∞–ª: "${text}"

–í–ê–ñ–ù–û:
- –û—Ç–≤–µ—Ç—å –ö–†–ê–¢–ö–û (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –≤ —Å—Ç–∏–ª–µ –ø–æ–¥—Ä–æ—Å—Ç–∫–∞
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–π —Å–≤–æ–µ–º—É –ø—Å–∏—Ö–æ—Ç–∏–ø—É –ò —Ç–µ–∫—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
- –î–æ–±–∞–≤—å —Ä–µ–º–∞—Ä–∫—É –≤ —Å–∫–æ–±–∫–∞—Ö –æ –¥–µ–π—Å—Ç–≤–∏–∏ –∏–ª–∏ —ç–º–æ—Ü–∏–∏
- –ë—É–¥—å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º
- –ù–ï –æ—Ç–≤–µ—á–∞–π –æ–¥–Ω–æ—Å–ª–æ–∂–Ω–æ ("–î–∞", "–ù–µ—Ç", "–•–æ—Ä–æ—à–æ")
- –ú–∏–Ω–∏–º—É–º 10 —Å–ª–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
- –ù–ï –Ω–∞—á–∏–Ω–∞–π –æ—Ç–≤–µ—Ç —Å–æ —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏
- –†–µ–º–∞—Ä–∫–∏ –≤ —Å–∫–æ–±–∫–∞—Ö (–¥–µ–π—Å—Ç–≤–∏—è, —ç–º–æ—Ü–∏–∏) –ø–∏—à–∏ –æ—Ç –¢–†–ï–¢–¨–ï–ì–û –ª–∏—Ü–∞: "(—Å–º–æ—Ç—Ä–∏—Ç –≤ —Å—Ç–æ—Ä–æ–Ω—É)", –∞ –ù–ï "(—Å–º–æ—Ç—Ä—é –≤ —Å—Ç–æ—Ä–æ–Ω—É)"

–¢–≤–æ–π –æ—Ç–≤–µ—Ç:`;

                try {
                    let reply = await callAI(prompt, 150);

                    // Strip leading "Name:" prefix if AI accidentally adds it
                    reply = reply.replace(/^[–ê-–Ø–ÅA-Z][–∞-—è—ëa-z]+\s*:\s*/u, '').trim();

                    // Validate response length (prevent one-word answers)
                    const wordCount = reply.trim().split(/\s+/).length;
                    if (wordCount < 5) {
                        // Fallback for too short responses
                        const fallbackReplies = [
                            `–ù—É... –Ω–µ –∑–Ω–∞—é, –∫–∞–∫ —Å–∫–∞–∑–∞—Ç—å... (—Å–º–æ—Ç—Ä–∏—Ç –≤ —Å—Ç–æ—Ä–æ–Ω—É)`,
                            `–≠—Ç–æ —Å–ª–æ–∂–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å... (–∑–∞–¥—É–º—ã–≤–∞–µ—Ç—Å—è)`,
                            `–Ø –ø—ã—Ç–∞—é—Å—å –ø–æ–Ω—è—Ç—å, –Ω–æ –ø–æ–∫–∞ –Ω–µ –æ—á–µ–Ω—å –ø–æ–ª—É—á–∞–µ—Ç—Å—è... (—á–µ—à–µ—Ç –∑–∞—Ç—ã–ª–æ–∫)`,
                            `–ú–æ–∂–µ—Ç–µ –æ–±—ä—è—Å–Ω–∏—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É? (—Å–º—É—â–∞–µ—Ç—Å—è)`
                        ];
                        const fallback = fallbackReplies[Math.floor(Math.random() * fallbackReplies.length)];
                        addMessage('student', `${responder.emoji} ${responder.name}: ${fallback}`, responder);
                    } else {
                        addMessage('student', `${responder.emoji} ${responder.name}: ${reply}`, responder);
                    }
                } catch (e) {
                    console.error('AI Error:', e);
                    // Better fallback based on state
                    let fallbackReply = '–•–æ—Ä–æ—à–æ...';
                    if (studentState.mood < 4) {
                        fallbackReply = '–õ–∞–¥–Ω–æ... (–æ—Ç–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è)';
                    } else if (studentState.engagement < 4) {
                        fallbackReply = '–£–≥—É... (—Å–º–æ—Ç—Ä–∏—Ç –≤ –æ–∫–Ω–æ)';
                    } else if (studentState.understanding < 4) {
                        fallbackReply = '–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª, –Ω–æ —Ö–æ—Ä–æ—à–æ... (–∫–∏–≤–∞–µ—Ç –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ)';
                    }
                    addMessage('student', `${responder.emoji} ${responder.name}: ${fallbackReply}`, responder);
                }
            }, 1500);
        }

        // Initialize Voice Input
        function initVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('Speech Recognition not supported');
                document.getElementById('voiceBtn').style.display = 'none';
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.continuous = false; // Stop after each utterance for lower latency
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            const voiceBtn = document.getElementById('voiceBtn');
            const input = document.getElementById('input');
            let finalTranscript = '';
            let isRecording = false;

            recognition.onstart = () => {
                isRecording = true;
                voiceBtn.classList.add('recording');
                finalTranscript = '';
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                input.value = finalTranscript + interimTranscript;
            };

            recognition.onend = () => {
                isRecording = false;
                voiceBtn.classList.remove('recording');
                const trimmed = finalTranscript.trim();
                if (trimmed) {
                    input.value = trimmed;
                    // Auto-send after voice input
                    send();
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                voiceBtn.classList.remove('recording');
            };

            voiceBtn.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                } else {
                    // Show recording state immediately on click (before onstart fires)
                    voiceBtn.classList.add('recording');
                    finalTranscript = '';
                    input.value = '';
                    recognition.start();
                }
            });
        }

        // Add message
        function addMessage(type, text, student = null) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            if (student) {
                const elem = document.getElementById(`student-${student.id}`);
                if (elem) {
                    elem.classList.add('speaking');
                    setTimeout(() => elem.classList.remove('speaking'), 2500);
                }
            }

            // AVATAR REACTION (Visual only, no voice)
            if (type === 'system') {
                if (window.setAvatarState) {
                    window.setAvatarState('talking');
                    setTimeout(() => window.setAvatarState('idle'), 2000);
                }
            }

            // AI-POWERED FEEDBACK ON EVERY TEACHER MESSAGE
            if (type === 'teacher') {
                // Analyze teacher's message and provide feedback
                setTimeout(async () => {
                    await analyzeTeacherMessage(text);
                }, 1500);

                // üî• TRACK TEACHER MESSAGE FOR FIREBASE
                if (typeof trackTeacherMessage === 'function') {
                    trackTeacherMessage(text);
                }
            }

            // Sync with AI Client history
            if (aiClient) {
                aiClient.recordMessage(type, text);
            }

            history.push({ type, text, timestamp: Date.now() });
        }

        // AI Analysis of Teacher's Message
        async function analyzeTeacherMessage(teacherText) {
            try {
                const context = history.slice(-4).map(m =>
                    `${m.type === 'teacher' ? '–£—á–∏—Ç–µ–ª—å' : '–£—á–µ–Ω–∏–∫'}: ${m.text}`
                ).join('\n');

                const prompt = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç-–ø–µ–¥–∞–≥–æ–≥. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ—Ä–∞–∑—É —É—á–∏—Ç–µ–ª—è –∏ –¥–∞–π –∫—Ä–∞—Ç–∫—É—é –æ—Ü–µ–Ω–∫—É.

–ö–æ–Ω—Ç–µ–∫—Å—Ç:
${context}

–§—Ä–∞–∑–∞ —É—á–∏—Ç–µ–ª—è: "${teacherText}"

–û—Ü–µ–Ω–∏ —ç—Ç—É —Ñ—Ä–∞–∑—É –ø–æ 3 –∫—Ä–∏—Ç–µ—Ä–∏—è–º (–∫–∞–∂–¥—ã–π 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ):
1. ‚úÖ –ß—Ç–æ —Ö–æ—Ä–æ—à–æ –≤ —ç—Ç–æ–π —Ñ—Ä–∞–∑–µ (–ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è)
2. ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫ (—á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫)
3. üí° –°–æ–≤–µ—Ç (–∫–∞–∫ —É–ª—É—á—à–∏—Ç—å –∏–ª–∏ —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ)

–û—Ç–≤–µ—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "good": "—Ç–µ–∫—Å—Ç",
  "risk": "—Ç–µ–∫—Å—Ç",
  "advice": "—Ç–µ–∫—Å—Ç",
  "tone": "positive|neutral|negative"
}`;

                const response = await callAI(prompt, 200, true);
                const analysis = JSON.parse(response);

                // Display feedback based on tone
                if (analysis.tone === 'negative') {
                    mentorHint(`‚ùå –û—Å—Ç–æ—Ä–æ–∂–Ω–æ: ${analysis.risk}`, 'error');
                    setTimeout(() => mentorHint(`üí° –°–æ–≤–µ—Ç: ${analysis.advice}`, 'warning'), 2000);
                } else if (analysis.tone === 'neutral') {
                    mentorHint(`‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: ${analysis.risk}`, 'warning');
                    setTimeout(() => mentorHint(`üí° ${analysis.advice}`, 'info'), 2000);
                } else {
                    mentorHint(`‚úÖ –•–æ—Ä–æ—à–æ: ${analysis.good}`, 'success');
                    if (analysis.advice) {
                        setTimeout(() => mentorHint(`üí° –î–∞–ª—å—à–µ: ${analysis.advice}`, 'info'), 2000);
                    }
                }
            } catch (e) {
                console.error('Analysis error:', e);
                // Fallback to simple analysis
                simpleAnalysis(teacherText);
            }
        }

        // Fallback simple analysis
        function simpleAnalysis(text) {
            const lower = text.toLowerCase();

            // Negative patterns
            if (lower.includes('–∑–∞–∫—Ä–æ–π') || lower.includes('–≤—ã–π–¥–∏') || lower.includes('–≤–æ–Ω')) {
                mentorHint('‚ùå –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç', 'error');
                setTimeout(() => mentorHint('üí° –ü–æ–ø—Ä–æ–±—É–π –º—è–≥—á–µ: "–î–∞–≤–∞–π —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–º—Å—è –Ω–∞ —É—Ä–æ–∫–µ"', 'warning'), 2000);
            }
            // Positive patterns
            else if (lower.includes('–º–æ–ª–æ–¥–µ—Ü') || lower.includes('–æ—Ç–ª–∏—á–Ω–æ') || lower.includes('—Ö–æ—Ä–æ—à–æ')) {
                mentorHint('‚úÖ –ü–æ–∑–∏—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤', 'success');
            }
            // Questions
            else if (lower.includes('–ø–æ—á–µ–º—É') || lower.includes('–∫–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å') || lower.includes('?')) {
                mentorHint('‚úÖ –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ä–∞–∑–≤–∏–≤–∞—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ', 'success');
            }
            // Neutral
            else {
                mentorHint('üí° –°–ª–µ–¥–∏ –∑–∞ —Ä–µ–∞–∫—Ü–∏–µ–π —É—á–µ–Ω–∏–∫–æ–≤', 'info');
            }
        }

        // Analyze Teacher Action for Scoring
        function analyzeTeacherAction(text) {
            const lower = text.toLowerCase();
            sessionScore.totalMessages++;

            // Positive patterns
            if (lower.includes('–º–æ–ª–æ–¥–µ—Ü') || lower.includes('–æ—Ç–ª–∏—á–Ω–æ') || lower.includes('—É–º–Ω–∏—Ü–∞') || lower.includes('–∑–¥–æ—Ä–æ–≤–æ')) {
                sessionScore.praises++;
                sessionScore.positiveActions++;
            }
            if (lower.includes('–ø–æ–Ω–∏–º–∞—é') || lower.includes('–¥–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä–µ–º') || lower.includes('–ø–æ–º–æ–≥—É')) {
                sessionScore.empathy++;
                sessionScore.positiveActions++;
            }
            if (lower.includes('–ø–æ—á–µ–º—É') || lower.includes('–∫–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å') || lower.includes('—á—Ç–æ —Å—á–∏—Ç–∞–µ—à—å')) {
                sessionScore.questions++;
                sessionScore.positiveActions++;
            }

            // Negative patterns
            if (lower.includes('–∑–∞–∫—Ä–æ–π') || lower.includes('–≤—ã–π–¥–∏') || lower.includes('–≤–æ–Ω') || lower.includes('–∑–∞–º–æ–ª—á–∏')) {
                sessionScore.aggression++;
                sessionScore.negativeActions++;
                sessionScore.conflicts++;
            }
            if (lower.includes('–¥–≤–æ–π–∫–∞') || lower.includes('–ø–ª–æ—Ö–æ') || lower.includes('—É–∂–∞—Å')) {
                sessionScore.negativeActions++;
            }

            // Neutral
            if (sessionScore.positiveActions === 0 && sessionScore.negativeActions === 0) {
                sessionScore.neutralActions++;
            }
        }

        // Calculate Local Score (1-10)
        function calculateLocalScore() {
            const baseScore = 5.0; // –ë–∞–∑–æ–≤—ã–π –±–∞–ª–ª

            // –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
            const praiseBonus = sessionScore.praises * 0.3;
            const empathyBonus = sessionScore.empathy * 0.4;
            const questionBonus = sessionScore.questions * 0.3;

            // –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
            const aggressionPenalty = sessionScore.aggression * 1.0;
            const conflictPenalty = sessionScore.conflicts * 0.5;

            // –ü–æ–¥—Å—á–µ—Ç
            let score = baseScore + praiseBonus + empathyBonus + questionBonus - aggressionPenalty - conflictPenalty;

            // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            score *= sessionScore.difficulty;

            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 1-10
            score = Math.max(1, Math.min(10, score));

            // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 1 –∑–Ω–∞–∫–∞
            return Math.round(score * 10) / 10;
        }

        // Mentor Hint System (Text-based, no voice) - NOW USES SEPARATE PANEL
        function mentorHint(hintText, type = 'info') {
            // Increment hint counter
            hintCount++;
            document.getElementById('hint-counter').textContent = `üí° ${hintCount}`;

            // Add hint to separate hints panel (NOT in chat)
            const hintsPanel = document.getElementById('hintsPanel');
            const div = document.createElement('div');
            div.className = `hint-item hint-${type} new-hint`;
            div.textContent = hintText;
            hintsPanel.appendChild(div);

            // Remove new-hint class after animation completes
            setTimeout(() => {
                div.classList.remove('new-hint');
            }, 3000);

            // Auto-scroll hints panel
            hintsPanel.scrollTop = hintsPanel.scrollHeight;

            // Remove old hints if more than 5 (increased for right panel)
            while (hintsPanel.children.length > 5) {
                hintsPanel.removeChild(hintsPanel.firstChild);
            }

            // Enhanced visual feedback on avatar with animations
            const avatarScene = document.getElementById('avatar-scene');
            const statusText = document.getElementById('status-text');

            if (avatarScene && statusText) {
                const originalText = statusText.textContent;

                // Different colors and animations for different types
                const animations = {
                    'success': { anim: 'nod', glow: 'positive-glow', icon: '‚úÖ', color: '#10b981', text: '–û—Ç–ª–∏—á–Ω–æ!' },
                    'warning': { anim: 'thinking', glow: '', icon: '‚ö†Ô∏è', color: '#f59e0b', text: '–í–Ω–∏–º–∞–Ω–∏–µ' },
                    'error': { anim: 'shake-head', glow: 'negative-glow', icon: '‚ùå', color: '#ef4444', text: '–û—à–∏–±–∫–∞' },
                    'info': { anim: 'thinking', glow: '', icon: 'üí°', color: '#3b82f6', text: '–ü–æ–¥—Å–∫–∞–∑–∫–∞' }
                };

                const config = animations[type] || animations['info'];

                // Apply animation and glow
                avatarScene.classList.add(config.anim);
                if (config.glow) {
                    avatarScene.classList.add(config.glow);
                }

                // Update status text
                statusText.textContent = `${config.icon} ${config.text}`;
                statusText.style.color = config.color;

                // Remove animations after completion
                setTimeout(() => {
                    avatarScene.classList.remove(config.anim);
                    if (config.glow) {
                        avatarScene.classList.remove(config.glow);
                    }
                    statusText.textContent = originalText;
                    statusText.style.color = '';
                }, 1000);
            }
        }

        // End lesson
        async function endLesson() {
            // Guard: warn if lesson is too short (< 30 seconds)
            if (lessonTime < 30) {
                const confirmed = confirm(
                    `–£—Ä–æ–∫ –¥–ª–∏—Ç—Å—è –≤—Å–µ–≥–æ ${lessonTime} —Å–µ–∫. –¢–∞–∫–æ–π –∫–æ—Ä–æ—Ç–∫–∏–π —É—Ä–æ–∫ —Å–ª–æ–∂–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å?`
                );
                if (!confirmed) return;
            }

            clearInterval(activityTimer);
            clearInterval(silenceTimer);

            // üî• FIREBASE INTEGRATION: Save session to Firebase with AI analysis
            if (typeof endLessonWithAnalysis === 'function') {
                await endLessonWithAnalysis();
            } else {
                alert('‚ö†Ô∏è Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è');
            }

            // Note: Firebase function handles redirect to dashboard
        }


        // AI helper with retry and timeout
        // AI helper with retry and timeout - UPDATED TO USE BACKEND
        async function callAI(prompt, maxTokens = 100, jsonMode = false, retries = 3) {
            const timeout = 15000; // 15 seconds timeout
            // Use backend API URL (dynamic for local vs production)
            const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const apiUrl = isLocal ? 'http://localhost:3000/api/chat' : '/api/chat';

            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: maxTokens,
                            temperature: 0.9,
                            response_format: jsonMode ? { type: "json_object" } : undefined
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.error || 'Unknown Backend Error');
                    }

                    return data.content;

                } catch (error) {
                    console.error(`API call failed (attempt ${attempt}/${retries}):`, error);

                    if (error.name === 'AbortError') {
                        console.error('Request timeout');
                    }

                    if (attempt === retries) {
                        throw error;
                    }

                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        // Enter key
        document.getElementById('input').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission
                send();
            }
        });

        // ==================== SCENARIO SAVING FUNCTIONS ====================

        function openSaveScenarioModal() {
            const checkboxes = document.querySelectorAll('.student-checkbox input:checked');
            const selectedStudents = Array.from(checkboxes).map(cb =>
                allStudents.find(s => s.id === parseInt(cb.value))
            );

            // Update preview
            const preview = document.getElementById('selectedStudentsPreview');
            preview.innerHTML = selectedStudents.map(s =>
                `<span class="student-preview-tag">${s.emoji} ${s.name} <span style="color: #9ca3af;">(${s.type})</span></span>`
            ).join('');

            // Show modal
            document.getElementById('saveScenarioModal').classList.remove('hidden');
        }

        function closeSaveScenarioModal() {
            document.getElementById('saveScenarioModal').classList.add('hidden');
            // Clear form
            document.getElementById('scenarioTitle').value = '';
            document.getElementById('scenarioDescription').value = '';
        }

        async function saveScenario() {
            const title = document.getElementById('scenarioTitle').value.trim();
            const description = document.getElementById('scenarioDescription').value.trim();
            const difficulty = document.querySelector('input[name="difficulty"]:checked').value;
            const useForAssessment = document.getElementById('useForAssessment').checked;

            if (!title) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è');
                return;
            }

            // Get selected students
            const checkboxes = document.querySelectorAll('.student-checkbox input:checked');
            const selectedStudentIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const selectedStudents = selectedStudentIds.map(id =>
                allStudents.find(s => s.id === id)
            );

            // Check if Firebase is available
            if (typeof firebase === 'undefined' || !firebase.auth().currentUser) {
                alert('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            const currentUser = firebase.auth().currentUser;

            // Create scenario object
            const scenarioData = {
                title: title,
                description: description,
                difficulty: difficulty,
                useForAssessment: useForAssessment,
                students: selectedStudents.map(s => ({
                    id: s.id,
                    name: s.name,
                    type: s.type,
                    emoji: s.emoji
                })),
                studentIds: selectedStudentIds,
                createdBy: currentUser.uid,
                createdByEmail: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                isPublic: false
            };

            try {
                // Save to Firestore
                const docRef = await firebase.firestore().collection('scenarios').add(scenarioData);

                console.log('Scenario saved with ID:', docRef.id);

                // Show success message
                alert(`‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π "${title}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!`);

                // Close modal
                closeSaveScenarioModal();

            } catch (error) {
                console.error('Error saving scenario:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è: ' + error.message);
            }
        }

        // ==================== END SCENARIO SAVING ====================

        // Init on load
        renderStudentSelection();
        document.getElementById('startBtn').onclick = startLesson;

        // For phone-incident scenario: pre-select phone student and hint
        const urlScenario = new URLSearchParams(window.location.search).get('scenario');
        if (urlScenario === 'phone-incident') {
            // Pre-check the –¢–µ–ª–µ—Ñ–æ–Ω—â–∏–∫ student (id=16) + 2 others
            setTimeout(() => {
                const phoneCheckbox = document.querySelector('.student-checkbox input[value="16"]');
                const otherCheckboxes = document.querySelectorAll('.student-checkbox input[value="2"], .student-checkbox input[value="1"]');
                if (phoneCheckbox) phoneCheckbox.checked = true;
                otherCheckboxes.forEach(cb => { cb.checked = true; });
                updateSelection();
            }, 100);
        }

        // Initialize voice input
        initVoiceInput();

        // Legacy endLesson removed to use the new Firebase-integrated version defined above

    </script>

    <!-- 3D AVATAR SCRIPT -->
    <script type="module">
        import * as THREE from 'three';

        // --- 2. THREE.JS SCENE ---
        const container = document.getElementById('avatar-scene');
        const scene = new THREE.Scene();

        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.z = 6;
        camera.position.y = 0;

        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 5, 5);
        scene.add(dirLight);

        // --- 3. PROCEDURAL SPROUT CHARACTER ---
        const sproutGroup = new THREE.Group();

        // Colors from reference
        const colorGreen = 0x6B8C42;
        const colorDarkGreen = 0x4A6630;
        const colorBrown = 0x8B5A2B;

        // Materials
        const matGreen = new THREE.MeshStandardMaterial({ color: colorGreen, roughness: 0.4, metalness: 0.1 });
        const matDarkGreen = new THREE.MeshStandardMaterial({ color: colorDarkGreen, roughness: 0.6 });
        const matBrown = new THREE.MeshStandardMaterial({ color: colorBrown, roughness: 0.8 });
        const matEyeWhite = new THREE.MeshBasicMaterial({ color: 0xFFFFFF });
        const matEyePupil = new THREE.MeshBasicMaterial({ color: 0x333333 });

        // HEAD (The Bulb)
        const headGeo = new THREE.SphereGeometry(1, 32, 32);
        // Deform slightly to shape like a teardrop/onion
        const pos = headGeo.attributes.position;
        for (let i = 0; i < pos.count; i++) {
            if (pos.getY(i) > 0) {
                pos.setX(i, pos.getX(i) * 0.8);
                pos.setZ(i, pos.getZ(i) * 0.8);
                pos.setY(i, pos.getY(i) * 1.2);
            }
        }
        headGeo.computeVertexNormals();
        const head = new THREE.Mesh(headGeo, matGreen);
        sproutGroup.add(head);

        // LEAVES (On top)
        const leafGeo = new THREE.SphereGeometry(0.4, 16, 16);
        leafGeo.scale(1, 0.2, 0.5);

        const leaf1 = new THREE.Mesh(leafGeo, matDarkGreen);
        leaf1.position.set(-0.3, 1.1, 0);
        leaf1.rotation.z = 0.5;
        leaf1.rotation.x = -0.2;
        sproutGroup.add(leaf1);

        const leaf2 = new THREE.Mesh(leafGeo, matDarkGreen);
        leaf2.position.set(0.3, 1.2, 0);
        leaf2.rotation.z = -0.5;
        leaf2.rotation.x = 0.2;
        sproutGroup.add(leaf2);

        // BODY (Small stem/body)
        const bodyGeo = new THREE.CylinderGeometry(0.5, 0.6, 1.2, 16);
        const body = new THREE.Mesh(bodyGeo, matGreen);
        body.position.y = -1.2;
        sproutGroup.add(body);

        // OVERALLS (Brown pants)
        const pantsGeo = new THREE.CylinderGeometry(0.65, 0.7, 0.8, 16);
        const pants = new THREE.Mesh(pantsGeo, matBrown);
        pants.position.y = -1.5;
        sproutGroup.add(pants);

        // EYES
        const eyeGroup = new THREE.Group();
        const eyeWGeo = new THREE.SphereGeometry(0.25, 16, 16);
        const eyeL = new THREE.Mesh(eyeWGeo, matEyeWhite);
        eyeL.position.set(-0.35, 0.1, 0.85);
        eyeL.scale.z = 0.5;

        const eyeR = eyeL.clone();
        eyeR.position.set(0.35, 0.1, 0.85);

        const pupilGeo = new THREE.SphereGeometry(0.12, 16, 16);
        const pupilL = new THREE.Mesh(pupilGeo, matEyePupil);
        pupilL.position.set(-0.35, 0.1, 0.98);
        pupilL.scale.z = 0.5;

        const pupilR = pupilL.clone();
        pupilR.position.set(0.35, 0.1, 0.98);

        eyeGroup.add(eyeL, eyeR, pupilL, pupilR);
        head.add(eyeGroup);

        scene.add(sproutGroup);

        // --- 4. ANIMATION LOOP ---
        let currentState = 'idle';
        let time = 0;
        let mouse = new THREE.Vector2();
        let targetRot = new THREE.Vector2();

        // Mouse Tracker
        document.addEventListener('mousemove', (e) => {
            const rect = renderer.domElement.getBoundingClientRect();
            if (e.clientX >= rect.left && e.clientX <= rect.right &&
                e.clientY >= rect.top && e.clientY <= rect.bottom) {
                mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            time += 0.05;

            // Look at Mouse
            targetRot.x = mouse.y * 0.3; // Up/Down
            targetRot.y = mouse.x * 0.3; // Left/Right

            sproutGroup.rotation.x += (targetRot.x - sproutGroup.rotation.x) * 0.1;
            sproutGroup.rotation.y += (targetRot.y - sproutGroup.rotation.y) * 0.1;

            // Idle Breath
            sproutGroup.position.y = Math.sin(time * 2) * 0.05 + 0.5;

            // Talking Animation
            if (currentState === 'talking') {
                head.scale.y = 1 + Math.sin(time * 15) * 0.05;
                sproutGroup.scale.y = 1 + Math.sin(time * 10) * 0.02;
            } else {
                head.scale.set(1, 1, 1);
                sproutGroup.scale.set(1, 1, 1);
            }

            renderer.render(scene, camera);
        }
        animate();

        // --- 5. GLOBAL EXPORTS ---
        window.setAvatarState = (state) => {
            currentState = state;
            const sceneContainer = document.getElementById('avatar-scene');
            if (state === 'talking') {
                sceneContainer.classList.add('talking');
            } else {
                sceneContainer.classList.remove('talking');
            }
        };

        window.speak = (text) => {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ru-RU';
                utterance.rate = 1.1;
                utterance.pitch = 1.3;

                // Auto-remove talking state when speech ends
                utterance.onend = () => {
                    setTimeout(() => window.setAvatarState('idle'), 500);
                };

                speechSynthesis.speak(utterance);
            }
        };

        // Toggle Avatar Scene (Collapse/Expand)
        function toggleAvatarScene() {
            const avatarScene = document.getElementById('avatar-scene');
            const toggleBtn = document.getElementById('avatarToggleBtn');

            avatarScene.classList.toggle('collapsed');

            // Save state to localStorage
            const isCollapsed = avatarScene.classList.contains('collapsed');
            localStorage.setItem('avatarSceneCollapsed', isCollapsed);
        }

        // Restore avatar scene state on page load
        window.addEventListener('DOMContentLoaded', () => {
            const isCollapsed = localStorage.getItem('avatarSceneCollapsed') === 'true';
            if (isCollapsed) {
                document.getElementById('avatar-scene').classList.add('collapsed');
            }
        });
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB7SBp_tDfeumEjJ6l8QpnamHeXA5OiWyg",
            authDomain: "test-89bad.firebaseapp.com",
            projectId: "test-89bad",
            storageBucket: "test-89bad.firebasestorage.app",
            messagingSenderId: "798844876458",
            appId: "1:798844876458:web:fa13cdaf2eec1a43ffc2d3"
        };
    </script>

    <!-- External Dependencies -->
    <script src="user-manager.js"></script>
    <script src="ai-client.js"></script>

    <!-- Session Tracking & Firebase Integration -->
    <script>
        // Initialize Firebase
        userManager.init(firebaseConfig);

        // Global session data
        let sessionData = {
            userId: null,
            scenarioId: null,
            startTime: null,
            endTime: null,
            duration: 0,
            messages: [],
            studentInteractions: {}
        };

        // Check authentication on load
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                // Not logged in - redirect to auth
                alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞');
                setTimeout(() => {
                    window.location.href = 'auth.html';
                }, 1500);
                return;
            }

            // User is logged in
            sessionData.userId = user.uid;
            sessionData.startTime = new Date().toISOString();

            // Get scenario from URL
            const urlParams = new URLSearchParams(window.location.search);
            sessionData.scenarioId = urlParams.get('scenario') || 'unknown';

            console.log('‚úÖ Session started:', sessionData);
        });

        // Track teacher messages
        function trackTeacherMessage(text) {
            sessionData.messages.push({
                timestamp: new Date().toISOString(),
                speaker: 'teacher',
                text: text,
                type: 'teacher_input'
            });
        }

        // Track student responses
        function trackStudentResponse(studentId, text, emotion) {
            sessionData.messages.push({
                timestamp: new Date().toISOString(),
                speaker: studentId,
                text: text,
                emotion: emotion,
                type: 'student_response'
            });

            // Track interaction count
            if (!sessionData.studentInteractions[studentId]) {
                sessionData.studentInteractions[studentId] = {
                    messagesCount: 0,
                    emotions: []
                };
            }
            sessionData.studentInteractions[studentId].messagesCount++;
            sessionData.studentInteractions[studentId].emotions.push(emotion);
        }

        // End Lesson - AI Analysis & Save to Firebase
        async function endLessonWithAnalysis() {
            console.log('üèÅ endLessonWithAnalysis triggered');

            if (!sessionData.userId) {
                alert('‚ö†Ô∏è –û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!');
                window.location.href = 'auth.html';
                return;
            }

            // Calculate duration
            const endTime = new Date();
            const durationSeconds = Math.round((endTime - new Date(sessionData.startTime)) / 1000);
            sessionData.endTime = endTime.toISOString();
            sessionData.duration = durationSeconds;

            // Show loading UI
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'ai-loading-overlay';
            loadingDiv.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.85); color: white;
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                z-index: 9999;
            `;
            loadingDiv.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 20px; animation: pulse 1.5s infinite;">ü§ñ</div>
                <h2 style="font-family: 'Inter', sans-serif;">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —É—Ä–æ–∫...</h2>
                <p style="margin-top: 10px; color: #ccc;">–û—Ü–µ–Ω–∏–≤–∞—é —Ä–µ–∞–∫—Ü–∏–∏ —É—á–µ–Ω–∏–∫–æ–≤ –∏ –º–µ—Ç–æ–¥–∏–∫—É</p>
                <style>@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }</style>
            `;
            document.body.appendChild(loadingDiv);

            try {
                // 1. Get AI Analysis
                console.log('ü§ñ Requesting AI analysis...', sessionData);
                let aiAnalysis;

                try {
                    // Fixed method name (getSessionAnalysis) and pass correct arguments
                    aiAnalysis = await aiClient.getSessionAnalysis(sessionData.scenarioId, sessionData.duration * 1000); // ms
                    console.log('‚úÖ AI analysis received:', aiAnalysis);
                } catch (aiError) {
                    console.error('‚ö†Ô∏è AI Analysis failed, using mock fallback:', aiError);
                    alert(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI: ${aiError.message}\n\n–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Vercel Dev —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000 (vercel dev).\n–ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.`);
                    // Fallback Mock Data
                    aiAnalysis = {
                        overall_score: 70,
                        feedback: "AI —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£—Ä–æ–∫ –∑–∞—Å—á–∏—Ç–∞–Ω.",
                        good_points: ["–£—Ä–æ–∫ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω"],
                        bad_points: ["–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"],
                        recommendations: ["–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ", "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ"],
                        skills: { empathy: 60, conflictResolution: 60, boundaryKeeping: 60, patience: 60 }
                    };
                }

                // 2. Prepare result object
                // 2. Prepare result object with safe defaults
                const safeSkills = aiAnalysis.skills || {};
                const sessionResult = {
                    ...sessionData,
                    duration: typeof sessionData.duration === 'number' && !isNaN(sessionData.duration) ? sessionData.duration : 0,
                    score: typeof aiAnalysis.overall_score === 'number' ? aiAnalysis.overall_score : 0,
                    aiAnalysis: aiAnalysis,
                    skillsGained: {
                        empathy: typeof safeSkills.empathy === 'number' ? safeSkills.empathy : 0,
                        conflictResolution: typeof safeSkills.conflictResolution === 'number' ? safeSkills.conflictResolution : 0,
                        boundaryKeeping: typeof safeSkills.boundaryKeeping === 'number' ? safeSkills.boundaryKeeping : (typeof safeSkills.boundaries === 'number' ? safeSkills.boundaries : 0),
                        patience: typeof safeSkills.patience === 'number' ? safeSkills.patience : 0
                    }
                };

                console.log('üíæ Saving to Firebase:', sessionResult);

                // 3. Save to Firebase - FIXED METHOD NAME (was saveSessionResult)
                const saveResult = await userManager.saveSessionResults(sessionResult);

                if (document.body.contains(loadingDiv)) {
                    document.body.removeChild(loadingDiv);
                }

                if (saveResult.success) {
                    console.log('‚úÖ Save successful, showing results...');
                    // Show detailed analysis modal
                    showAnalysisResults(sessionResult);
                } else {
                    throw new Error(saveResult.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }

            } catch (error) {
                console.error('‚ùå Critical error in endLessonWithAnalysis:', error);
                if (document.getElementById('ai-loading-overlay')) {
                    document.body.removeChild(document.getElementById('ai-loading-overlay'));
                }

                // Emergency Save Option
                if (confirm(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}\n–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞?`)) {
                    const basicResult = {
                        ...sessionData,
                        score: 50,
                        aiAnalysis: { feedback: "Emergency save: " + error.message, overall_score: 50 },
                        skillsGained: { empathy: 50, conflictResolution: 50, boundaryKeeping: 50, patience: 50 }
                    };
                    await userManager.saveSessionResults(basicResult); // Fixed method name here too
                    alert('‚úÖ –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                    window.location.href = 'dashboard.html';
                }
            }
        }

        // Show detailed analysis results modal
        function showAnalysisResults(sessionResult) {
            const analysis = sessionResult.aiAnalysis || {};
            const score = sessionResult.score || 0;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); color: white;
                display: flex; align-items: flex-start; justify-content: center;
                z-index: 10000; overflow-y: auto; padding: 20px;
            `;
            modal.scrollTop = 0;

            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border-radius: 20px; padding: 40px; max-width: 700px; width: 100%;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.5);">

                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 80px; margin-bottom: 10px;">
                            ${score >= 80 ? 'üåü' : score >= 60 ? 'üëç' : score >= 40 ? 'üìö' : 'üí™'}
                        </div>
                        <h1 style="font-size: 36px; margin: 10px 0; font-weight: 700;">
                            –£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω!
                        </h1>
                        <div style="font-size: 48px; font-weight: 800; margin: 20px 0;">
                            ${score}/100
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center;">
                            <span style="font-size: 24px; margin-right: 10px;">üí¨</span>
                            –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞
                        </h3>
                        <p style="margin: 0; line-height: 1.6; font-size: 16px;">
                            ${analysis.feedback || '–ê–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}
                        </p>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center;">
                            <span style="font-size: 24px; margin-right: 10px;">‚úÖ</span>
                            –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Ö–æ—Ä–æ—à–æ
                        </h3>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            ${(analysis.good_points || ['–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç']).map(point =>
                                `<li style="margin-bottom: 8px;">${point}</li>`
                            ).join('')}
                        </ul>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center;">
                            <span style="font-size: 24px; margin-right: 10px;">‚ö†Ô∏è</span>
                            –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å
                        </h3>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            ${(analysis.bad_points || ['–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç']).map(point =>
                                `<li style="margin-bottom: 8px;">${point}</li>`
                            ).join('')}
                        </ul>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center;">
                            <span style="font-size: 24px; margin-right: 10px;">üí°</span>
                            –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                        </h3>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            ${(analysis.recommendations || ['–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è']).map(rec =>
                                `<li style="margin-bottom: 8px;">${rec}</li>`
                            ).join('')}
                        </ul>
                    </div>

                    ${analysis.skills ? `
                    <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 20px;">üìä –û—Ü–µ–Ω–∫–∞ –Ω–∞–≤—ã–∫–æ–≤</h3>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                            ${Object.entries(analysis.skills).map(([skill, value]) => {
                                const skillNames = {
                                    empathy: '–≠–º–ø–∞—Ç–∏—è',
                                    conflictResolution: '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤',
                                    boundaryKeeping: '–ì—Ä–∞–Ω–∏—Ü—ã',
                                    patience: '–¢–µ—Ä–ø–µ–Ω–∏–µ'
                                };
                                const explanation = analysis.skillsExplanation && analysis.skillsExplanation[skill]
                                    ? analysis.skillsExplanation[skill]
                                    : '';
                                return `
                                    <div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <div style="font-weight: 600;">${skillNames[skill] || skill}</div>
                                            <div style="font-size: 18px; font-weight: 700; opacity: 0.9;">${value}/100</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); border-radius: 10px; height: 12px; overflow: hidden; margin-bottom: 8px;">
                                            <div style="background: linear-gradient(90deg, #4ade80, #22c55e);
                                                       height: 100%; width: ${value}%; border-radius: 10px;"></div>
                                        </div>
                                        ${explanation ? `
                                        <div style="font-size: 13px; line-height: 1.5; opacity: 0.85; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                            üí¨ ${explanation}
                                        </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <button onclick="window.location.href='dashboard.html'"
                            style="width: 100%; padding: 18px; font-size: 18px; font-weight: 600;
                                   background: white; color: #667eea; border: none; border-radius: 12px;
                                   cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';">
                        –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –¥–∞—à–±–æ—Ä–¥
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
            modal.scrollTop = 0;
        }
    </script>

</body>

</html>